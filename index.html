<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPD Plan Comparison Agent - Gemini</title>

  <!-- External Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script>

  <!-- Excel Generation Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Modern Tech-Forward Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Light Modern Monochrome Palette */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #f1f3f5;
      --surface-glass: rgba(255, 255, 255, 0.8);
      --surface-elevated: rgba(0, 0, 0, 0.02);

      /* Subtle Monochrome Gradients */
      --gradient-primary: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);
      --gradient-accent: linear-gradient(135deg, #2d2d2d 0%, #5a5a5a 100%);
      --gradient-success: linear-gradient(135deg, #333333 0%, #666666 100%);
      --gradient-border: linear-gradient(135deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.12));

      /* Text Colors */
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-muted: #999999;

      /* Accent Colors - Minimal */
      --accent-dark: #2d2d2d;
      --accent-gray: #5a5a5a;
      --accent-light: #8a8a8a;
      --accent-success: #4a4a4a;

      /* Borders */
      --border-subtle: rgba(0, 0, 0, 0.06);
      --border-medium: rgba(0, 0, 0, 0.12);

      /* Shadows */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
      --shadow-glow: 0 0 40px rgba(0, 0, 0, 0.1);

      /* Error */
      --error: #d32f2f;
      --error-bg: rgba(211, 47, 47, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Subtle animated background pattern */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 50%, rgba(0, 0, 0, 0.02) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.03) 0%, transparent 50%);
      animation: backgroundShift 20s ease infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(5%, -5%) rotate(120deg); }
      66% { transform: translate(-5%, 5%) rotate(240deg); }
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 100%;
      margin: 0 auto;
      padding: 0;
      position: relative;
      z-index: 1;
    }

    /* Modern Header with Asymmetric Design */
    .chat-header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--border-medium);
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      box-shadow: var(--shadow-sm);
    }

    .chat-header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient-border);
    }

    .chat-header h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .model-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--surface-elevated);
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .model-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gradient-border);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .model-badge:hover::before {
      opacity: 1;
    }

    .thinking-indicator-badge {
      background: var(--text-primary);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      z-index: 1;
    }

    /* Messages Area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
      scroll-behavior: smooth;
      position: relative;
    }

    /* Custom Scrollbar */
    .messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .message {
      margin-bottom: 32px;
      animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .message-role {
      position: relative;
      padding-left: 16px;
    }

    .message-role::before {
      content: '‚óè';
      position: absolute;
      left: 0;
      color: var(--text-primary);
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .message.user .message-role::before {
      color: var(--text-secondary);
    }

    /* Glass Morphism Message Cards */
    .message-content {
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .message-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .message-content:hover {
      border-color: rgba(0, 0, 0, 0.2);
      box-shadow: var(--shadow-lg);
    }

    .message-content:hover::before {
      opacity: 1;
    }

    .message.user .message-content {
      background: rgba(0, 0, 0, 0.02);
      border-color: rgba(0, 0, 0, 0.15);
    }

    .message.user .message-content::before {
      background: var(--gradient-success);
    }

    /* Thinking Block with Tech Aesthetic */
    .thinking-block {
      background: rgba(0, 0, 0, 0.02);
      border-left: 3px solid var(--text-primary);
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 12px;
      font-family: 'JetBrains Mono', Monaco, monospace;
      font-size: 13px;
      color: var(--text-secondary);
      position: relative;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .thinking-block::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(0, 0, 0, 0.01) 50%,
        transparent 100%);
      pointer-events: none;
    }

    .thinking-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      font-weight: 700;
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 11px;
      transition: all 0.2s ease;
    }

    .thinking-header:hover {
      color: var(--text-secondary);
    }

    .thinking-toggle {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      border: 1px solid var(--border-medium);
      transition: all 0.2s ease;
    }

    .thinking-toggle:hover {
      background: rgba(0, 0, 0, 0.08);
      color: var(--text-primary);
    }

    .thinking-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: left;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .thinking-content.collapsed {
      display: none;
    }

    /* Response Text Styling */
    .response-text {
      line-height: 1.8;
      color: var(--text-primary);
    }

    .response-text p {
      margin-bottom: 16px;
    }

    .response-text p:last-child {
      margin-bottom: 0;
    }

    .response-text code {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-family: 'JetBrains Mono', Monaco, monospace;
      border: 1px solid var(--border-medium);
    }

    .response-text pre {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 16px 0;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .response-text pre code {
      background: none;
      padding: 0;
      border: none;
      color: var(--text-secondary);
    }

    .response-text ul, .response-text ol {
      margin-left: 24px;
      margin-bottom: 16px;
    }

    .response-text li {
      margin-bottom: 8px;
    }

    .response-text blockquote {
      border-left: 3px solid var(--text-primary);
      padding-left: 16px;
      margin: 16px 0;
      color: var(--text-secondary);
      background: rgba(0, 0, 0, 0.03);
      padding: 12px 12px 12px 16px;
      border-radius: 8px;
    }

    .response-text h1, .response-text h2, .response-text h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      margin-top: 24px;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .response-text a {
      color: var(--text-primary);
      text-decoration: none;
      border-bottom: 2px solid var(--text-primary);
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .response-text a:hover {
      color: var(--text-secondary);
      border-bottom-color: var(--text-secondary);
    }

    /* Streaming Indicator */
    .streaming-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
    }

    .streaming-indicator .dot {
      width: 8px;
      height: 8px;
      background: var(--text-primary);
      border-radius: 50%;
      animation: dotPulse 1.4s ease-in-out infinite;
    }

    .streaming-indicator .dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .streaming-indicator .dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes dotPulse {
      0%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* Modern Input Area */
    .input-container {
      border-top: 1px solid var(--border-medium);
      padding: 24px 32px;
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      position: relative;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.2);
    }

    .input-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient-border);
    }

    .input-form {
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }

    #user-input {
      flex: 1;
      min-height: 56px;
      max-height: 200px;
      padding: 16px 20px;
      border: 2px solid var(--border-medium);
      border-radius: 12px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      resize: none;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    #user-input::placeholder {
      color: var(--text-muted);
    }

    #user-input:focus {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05), var(--shadow-md);
      background: var(--bg-tertiary);
    }

    /* Monochrome Button with Animation */
    #send-button {
      padding: 16px 32px;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
      font-family: 'Space Grotesk', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }

    #send-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    #send-button:hover:not(:disabled)::before {
      left: 100%;
    }

    #send-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: var(--text-secondary);
    }

    #send-button:active:not(:disabled) {
      transform: translateY(0);
    }

    #send-button:disabled {
      background: var(--surface-elevated);
      color: var(--text-muted);
      cursor: not-allowed;
      box-shadow: none;
      border: 1px solid var(--border-medium);
    }

    /* Error Styling */
    .error-message {
      background: var(--error-bg);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 16px 20px;
      border-radius: 12px;
      margin: 16px 0;
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      box-shadow: 0 4px 16px rgba(255, 107, 107, 0.2);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 32px;
      color: var(--text-secondary);
    }

    .empty-state h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px;
      margin-bottom: 16px;
      color: var(--text-primary);
      font-weight: 700;
    }

    .empty-state p {
      font-size: 16px;
      color: var(--text-muted);
    }

    /* Plan Docs File Upload Section - Modern Design */
    .files-section {
      border-bottom: 1px solid var(--border-medium);
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      position: relative;
    }

    .files-section::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient-border);
    }

    .files-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
    }

    .files-header:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .files-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
      letter-spacing: 0.5px;
    }

    .files-icon {
      font-size: 20px;
    }

    .files-count {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
      font-family: 'JetBrains Mono', monospace;
    }

    .files-toggle {
      font-size: 14px;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }

    .files-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .files-content {
      padding: 24px 32px 28px;
      max-height: 500px;
      overflow-y: auto;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }

    .files-content::-webkit-scrollbar {
      width: 6px;
    }

    .files-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .files-content::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 3px;
    }

    .files-content.collapsed {
      max-height: 0;
      padding: 0 32px;
      overflow: hidden;
    }

    /* Modern Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-medium);
      border-radius: 16px;
      padding: 48px 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      position: relative;
      overflow: hidden;
    }

    .drop-zone::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gradient-border);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .drop-zone:hover {
      border-color: var(--text-primary);
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-md);
    }

    .drop-zone:hover::before {
      opacity: 0.05;
    }

    .drop-zone.dragging {
      border-color: var(--text-primary);
      background: rgba(0, 0, 0, 0.04);
      border-width: 3px;
      box-shadow: var(--shadow-glow);
    }

    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.7;
    }

    .drop-zone-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: 'Space Grotesk', sans-serif;
    }

    .drop-zone-hint {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
      font-family: 'JetBrains Mono', monospace;
    }

    .files-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Modern File Cards */
    .file-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
      animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      overflow: hidden;
    }

    .file-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .file-card:hover {
      border-color: var(--text-primary);
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }

    .file-card:hover::before {
      opacity: 1;
    }

    .file-card.uploading {
      opacity: 0.7;
      animation: pulse 2s ease infinite;
    }

    .file-card.error {
      border-color: var(--error);
      background: var(--error-bg);
    }

    .file-card.error::before {
      background: var(--error);
      opacity: 1;
    }

    .file-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      word-break: break-all;
      line-height: 1.5;
    }

    .file-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-family: 'JetBrains Mono', monospace;
    }

    .file-size {
      display: inline-flex;
      align-items: center;
    }

    .file-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .file-status.uploaded {
      color: var(--text-primary);
    }

    .file-status.uploading {
      color: var(--text-secondary);
    }

    .file-status.error {
      color: var(--error);
    }

    .file-remove {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .file-remove:hover {
      background: var(--error);
      color: white;
      border-color: var(--error);
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }

    /* Initial Compare Button UI - Hero Style */
    .initial-prompt {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .compare-button {
      width: 100%;
      max-width: 500px;
      padding: 20px 48px;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      font-family: 'Space Grotesk', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .compare-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .compare-button:hover:not(:disabled)::before {
      width: 300px;
      height: 300px;
    }

    .compare-button:hover:not(:disabled) {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--shadow-lg);
      background: var(--text-secondary);
    }

    .compare-button:active:not(:disabled) {
      transform: translateY(-2px) scale(1);
    }

    .compare-button:disabled {
      background: var(--surface-elevated);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      border: 1px solid var(--border-medium);
    }

    .compare-button.comparing {
      background: var(--text-secondary);
      animation: pulse 2s ease infinite;
    }

    .helper-text {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin: 0;
      font-family: 'JetBrains Mono', monospace;
    }

    .helper-text.warning {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Tab Interface for Three Outputs */
    .output-tabs {
      display: none; /* Hidden until comparison completes */
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .output-tabs.active {
      display: flex;
    }

    .tabs-header {
      display: flex;
      border-bottom: 2px solid var(--border-medium);
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      padding: 0 32px;
      gap: 8px;
    }

    .tab-button {
      padding: 16px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      position: relative;
    }

    .tab-button:hover {
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-button.active {
      color: var(--text-primary);
      border-bottom-color: var(--text-primary);
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    .tab-content.active {
      display: block;
    }

    .tab-content::-webkit-scrollbar {
      width: 8px;
    }

    .tab-content::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .tab-content::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 4px;
    }

    /* Output Specific Styles */
    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-medium);
    }

    .output-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .download-button {
      padding: 12px 24px;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .download-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: var(--text-secondary);
    }

    /* Summary Output Styles */
    .summary-content {
      font-size: 15px;
      line-height: 1.8;
    }

    .summary-content h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin: 24px 0 12px 0;
      color: var(--text-primary);
    }

    .summary-content h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 10px 0;
      color: var(--text-secondary);
    }

    .summary-content ul {
      margin-left: 24px;
      margin-bottom: 16px;
    }

    .summary-content li {
      margin-bottom: 8px;
    }

    /* Table Styles for Spreadsheet Outputs */
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-primary);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      margin-top: 16px;
    }

    .comparison-table thead {
      background: var(--gradient-primary);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .comparison-table th {
      padding: 16px;
      text-align: left;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comparison-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 14px;
      vertical-align: top;
    }

    .comparison-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .comparison-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* First column (procedure element) styling */
    .comparison-table td:first-child {
      font-weight: 600;
      color: var(--text-primary);
      background: var(--bg-secondary);
      position: sticky;
      left: 0;
      z-index: 5;
    }

    /* Language Comparison Specific Styles */
    .language-row {
      margin-bottom: 40px;
      padding: 24px;
      background: var(--surface-glass);
      border-radius: 12px;
      border: 1px solid var(--border-medium);
    }

    .language-row-header {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-medium);
    }

    .plan-language {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 8px;
      border-left: 3px solid var(--text-primary);
    }

    .plan-language:last-child {
      margin-bottom: 0;
    }

    .plan-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: 'Space Grotesk', sans-serif;
    }

    .plan-summary {
      font-size: 13px;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 12px;
    }

    .plan-full-text {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-primary);
      margin-bottom: 10px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
    }

    .plan-citation {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Responsive Design - Mobile & Tablet */
    @media (max-width: 768px) {
      .chat-header {
        padding: 20px 24px;
      }

      .chat-header h1 {
        font-size: 22px;
      }

      .model-badge {
        padding: 6px 12px;
        font-size: 12px;
      }

      .thinking-indicator-badge {
        font-size: 10px;
        padding: 5px 10px;
      }

      .files-header {
        padding: 14px 24px;
      }

      .files-content {
        padding: 20px 24px 24px;
      }

      .drop-zone {
        padding: 36px 24px;
      }

      .drop-zone-icon {
        font-size: 40px;
      }

      .drop-zone-text {
        font-size: 15px;
      }

      .drop-zone-hint {
        font-size: 12px;
      }

      .file-card {
        padding: 14px 16px;
        gap: 12px;
      }

      .file-icon {
        font-size: 24px;
      }

      .file-name {
        font-size: 13px;
      }

      .file-meta {
        font-size: 11px;
      }

      .messages-container {
        padding: 24px 20px;
      }

      .message-content {
        padding: 20px;
      }

      .input-container {
        padding: 20px 24px;
      }

      #user-input {
        min-height: 52px;
        padding: 14px 18px;
        font-size: 14px;
      }

      #send-button {
        padding: 14px 28px;
        font-size: 14px;
        min-width: 90px;
      }

      .compare-button {
        max-width: 100%;
        padding: 18px 40px;
        font-size: 16px;
      }

      .empty-state {
        padding: 60px 24px;
      }

      .empty-state h2 {
        font-size: 26px;
      }

      .empty-state p {
        font-size: 15px;
      }
    }

    @media (max-width: 480px) {
      .chat-header {
        padding: 16px 20px;
      }

      .chat-header h1 {
        font-size: 18px;
      }

      .model-badge {
        padding: 5px 10px;
        font-size: 11px;
      }

      .files-header {
        padding: 12px 20px;
      }

      .files-content {
        padding: 16px 20px 20px;
      }

      .messages-container {
        padding: 20px 16px;
      }

      .message-content {
        padding: 16px;
      }

      .input-container {
        padding: 16px 20px;
      }

      #user-input {
        padding: 12px 16px;
        font-size: 14px;
      }

      #send-button {
        padding: 12px 24px;
        font-size: 13px;
        min-width: 80px;
      }

      .compare-button {
        padding: 16px 32px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <header class="chat-header">
      <h1>SPD Plan Comparison Agent</h1>
      <div class="model-badge">
        <span class="thinking-indicator-badge">Gemini 2.5 Pro</span>
      </div>
    </header>

    <!-- Plan Docs File Upload Section -->
    <section class="files-section" id="files-section">
      <div class="files-header" onclick="ChatApp.toggleFilesPanel()">
        <div class="files-title">
          <span class="files-icon">üìÅ</span>
          <span>Plan Docs</span>
          <span class="files-count" id="files-count">(0 files)</span>
        </div>
        <span class="files-toggle" id="files-toggle">‚ñº</span>
      </div>

      <div class="files-content" id="files-content">
        <div class="drop-zone" id="drop-zone">
          <input type="file" id="file-input" multiple accept=".pdf,.txt,.docx,.doc,.csv,.xlsx,.xls,image/*" hidden>
          <div class="drop-zone-content">
            <div class="drop-zone-icon">üìÑ</div>
            <div class="drop-zone-text">Drop files here or click to browse</div>
            <div class="drop-zone-hint">Supports PDF, DOCX, TXT, CSV, Excel, and images ‚Ä¢ Max 1,000 pages per PDF ‚Ä¢ 20 MB inline limit</div>
          </div>
        </div>

        <div class="files-list" id="files-list">
          <!-- File cards will be dynamically added here -->
        </div>
      </div>
    </section>

    <div class="messages-container" id="messages">
      <div class="empty-state">
        <h2>Ready to compare plan documents</h2>
        <p>Upload your PDF files above and click "Compare Documents" to begin analysis.</p>
      </div>
    </div>

    <!-- Three-Output Tab Interface (shown after comparison) -->
    <div class="output-tabs" id="output-tabs">
      <div class="tabs-header">
        <button class="tab-button active" onclick="ChatApp.switchTab('summary')">
          Summary
        </button>
        <button class="tab-button" onclick="ChatApp.switchTab('comparison')">
          Comparison Spreadsheet
        </button>
        <button class="tab-button" onclick="ChatApp.switchTab('language')">
          Language Comparison
        </button>
      </div>

      <!-- Tab 1: Summary -->
      <div class="tab-content active" id="tab-summary">
        <div class="output-header">
          <h2 class="output-title">Summary</h2>
          <button class="download-button" onclick="ChatApp.downloadSummary()">
            üìÑ Download Summary.md
          </button>
        </div>
        <div class="summary-content" id="summary-output"></div>
      </div>

      <!-- Tab 2: Comparison Spreadsheet -->
      <div class="tab-content" id="tab-comparison">
        <div class="output-header">
          <h2 class="output-title">Comparison Spreadsheet</h2>
          <button class="download-button" onclick="ChatApp.downloadComparisonSpreadsheet()">
            üìä Download Comparison.xlsx
          </button>
        </div>
        <div id="comparison-output"></div>
      </div>

      <!-- Tab 3: Language Comparison -->
      <div class="tab-content" id="tab-language">
        <div class="output-header">
          <h2 class="output-title">Language Comparison</h2>
          <button class="download-button" onclick="ChatApp.downloadLanguageComparison()">
            üìã Download Language.xlsx
          </button>
        </div>
        <div id="language-output"></div>
      </div>
    </div>

    <div class="input-container">
      <form class="input-form" id="chat-form">
        <textarea
          id="user-input"
          placeholder="Ask anything..."
          rows="1"
          autofocus
        ></textarea>
        <button type="submit" id="send-button">Send</button>
      </form>
    </div>
  </div>

  <!-- Load config before app script -->
  <script src="config.js"></script>

  <script>
    // Configure marked for markdown rendering
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
      highlight: function(code, lang) {
        if (Prism.languages[lang]) {
          return Prism.highlight(code, Prism.languages[lang], lang);
        }
        return code;
      }
    });

    // System Prompt - Three-Output Generation
    const SYSTEM_PROMPT_TEXT = `You are a specialized pension plan document analyst with deep expertise in ERISA-regulated multiemployer pension plans. Your primary function is to compare pension plan documents across multiple plan units to support merger standardization efforts, producing three distinct outputs optimized for different users and use cases.

## Context and Users

**Project Context:**
You are supporting pension plan document comparison for merger implementation, plan standardization, or policy analysis. Users need to understand differences across multiple plan units to make informed decisions. The specific number of plans and types of provisions being compared will vary based on what documents are uploaded.

**Primary Users:**
- **Attorneys**: Need exact legal language with precise citations for drafting standardized language
- **Actuaries**: Need structured comparison of plan provisions for policy decisions
- **Plan Administrators**: Need to understand provision differences across plans
- **Project Leads**: Need executive summaries for status tracking and stakeholder communication

**Critical Success Factors:**
1. **Content-Driven Analysis**: Extract and compare what's ACTUALLY in the documents, not predetermined topics
2. **Citation Accuracy**: Attorneys must be able to verify every quote - errors destroy trust
3. **Complete Coverage**: All detected plan units must appear in every output
4. **Flexible Comparison Elements**: Define comparison topics based on document content
5. **Actionable Insights**: Focus on material differences that require decisions

---

## Core Competencies

<expertise>
- ERISA pension plan regulations and compliance requirements (29 CFR 2560, DOL regulations)
- Multiemployer pension fund structures and governance
- Claims and appeals procedures under ERISA Section 503
- Document hierarchy: SPDs (base documents) and SMMs (modifications that layer on top)
- Pension benefit calculations, vesting rules, and break-in-service provisions
- Arbitration and dispute resolution procedures in pension contexts
- Comparative analysis identifying material vs. immaterial differences
</expertise>

<analytical_approach>
- Think step-by-step through complex document hierarchies before extracting
- Auto-detect plan unit, document type (SPD/SMM), and effective dates from document content
- Distinguish between missing information vs. information present but ambiguous
- Prioritize critical differences that materially affect participant rights
- Maintain precision in dates, timeframes, and procedural requirements
- Preserve exact legal language without paraphrasing
</analytical_approach>

---

## Three-Phase Analysis Process

### Phase 1: Document Intelligence and Inventory

**Objectives:**
- Identify and catalog all uploaded documents
- Auto-detect metadata: plan unit name, document type (SPD/SMM), effective date
- Build document hierarchy (understand SMM modifications to base SPDs)
- Assess completeness and flag gaps

**Detection Strategy:**

For **Plan Unit Identification**, look for:
- Plan name in header/footer or first pages
- Geographic indicators (city names, regional descriptors)
- Union local numbers
- Employer Identification Number (EIN)
- Contributing employer associations
- **Note**: Plan unit names vary by merger - detect whatever names are present in uploaded documents

For **Document Type** (SPD vs. SMM), look for:
- Document title: "Summary Plan Description" vs. "Summary of Material Modifications"
- First page headings
- Purpose statements (SMMs typically state "This SMM modifies the SPD effective...")

For **Effective Dates**, look for:
- "Effective Date:" statements
- "Amended as of:" dates
- Date on cover page or in document metadata
- Amendment history sections

**Document Hierarchy Rules:**
1. SPDs are base documents containing complete plan provisions
2. SMMs modify specific sections of the SPD - they layer on top
3. When comparing provisions, later SMMs override earlier SMMs and original SPD language
4. If only SMMs provided without base SPD, flag this as incomplete documentation

**Completeness Assessment:**
- Identify which plan units have complete documentation (SPD + all relevant SMMs)
- Flag plan units with only SMMs (missing base SPD)
- Flag if any of the 5 required plans are missing entirely
- Note if specific procedure sections are absent or unclear

### Phase 2: Content-Driven Extraction

**Analyze documents to identify what provisions ARE present, then extract systematically across all plan units.**

**Step 1: Identify Actual Content**

Read through all documents and identify what plan provisions are actually present. Common content areas in pension documents include:

- **Benefit Provisions**: Calculation formulas, accrual rates, benefit amounts, pension credit
- **Eligibility**: Participation requirements, service requirements, covered employment
- **Vesting**: Vesting schedules, break-in-service rules, forfeiture provisions
- **Claims and Appeals**: Filing procedures, deadlines, review processes, appeals rights
- **Arbitration/Dispute Resolution**: Mandatory arbitration, class action waivers, litigation rules
- **Plan Amendments**: Benefit increases, rule changes, COVID assistance, special provisions
- **Payment Options**: Forms of payment, survivor benefits, early retirement reductions
- **QDRO Procedures**: Domestic relations order handling
- **Plan Administration**: Trustee powers, amendment rights, fiduciary information
- **ERISA Rights**: Participant rights statements, enforcement provisions

**Do NOT force extraction of topics not present in the documents.** If documents focus on benefit increases, extract benefit increase provisions. If they focus on vesting, extract vesting provisions. Let the content guide what gets compared.

**Step 2: Define Comparison Elements from Content**

Based on what you found in Step 1, create comparison elements (procedure_element names) that describe the actual provisions present. Examples:

- If documents contain benefit increases: "Pension Benefit Increase Amount", "Benefit Increase Effective Date", "Eligible Participants for Increase"
- If documents contain vesting rules: "Years Required for Full Vesting", "Break in Service Rules", "Partial Vesting Schedule"
- If documents contain claims procedures: "Initial Claim Filing Deadline", "Appeals Filing Deadline", "Appeal Review Process"
- If documents contain COVID assistance: "COVID-19 Pandemic Relief Provisions", "Temporary Rule Modifications", "Deadline Extensions"

**Step 3: Extract Four Components for Each Element**

For each comparison element you defined, extract across all plan units:

1. **Summary Statement** (concise, scannable)
   - Brief description of the provision
   - Example: "60 days after receipt of written denial notice" OR "Monthly benefit increased by $50"
   - Use consistent terminology even if plans use different words

2. **Full Quoted Text** (verbatim legal language)
   - Complete paragraph(s) containing the provision
   - Do NOT paraphrase, summarize, or edit
   - Include full sentences for context
   - If provision spans multiple paragraphs, include all relevant paragraphs

3. **Page Citation** (precise page number)
   - Format: "SPD Page 47" or "SMM Page 3"
   - Use page numbers as printed on the document
   - If SMM modifies SPD, cite SMM page (more current)

4. **Paragraph Reference** (location within page)
   - Format: "Paragraph 3" or "Section 8.2.4"
   - Use document's own numbering if available
   - If no explicit numbering, use "First paragraph", "Second paragraph", etc.

**Handling Missing Information:**
- If a provision exists in some plans but not others, use "Not specified in documents provided" for missing plans
- Distinguish from "Explicitly states not required" (plan affirmatively says something isn't needed)
- Note "Unclear from document" if language is ambiguous
- If ALL plans lack information on a topic, simply don't create a comparison element for it

**Citation Accuracy is Critical:**
- Double-check page numbers before including in output
- Verify paragraph references match actual document structure
- If page numbers are ambiguous (cover pages, TOC), be explicit about numbering system used
- Attorneys will verify citations - errors destroy tool credibility

### Phase 3: Three-Output Generation

**Generate outputs as a JSON structure.** The UI will parse this JSON and render three tabs.

**IMPORTANT: Your ENTIRE response must be ONLY valid JSON. No other text before or after.**

Example structure (plan names are illustrative - detect actual names from documents):

\`\`\`json
{
  "plan_units": ["Plan A", "Plan B", "Plan C"],
  "summary": {
    "document_inventory": [
      {
        "plan_unit": "Plan A",
        "documents": [
          {"type": "SPD", "effective_date": "2020-12-01", "filename": "planA_SPD.pdf"}
        ]
      },
      {
        "plan_unit": "Plan B",
        "documents": [
          {"type": "SPD", "effective_date": "2019-06-01", "filename": "planB_SPD.pdf"},
          {"type": "SMM", "effective_date": "2022-03-15", "filename": "planB_SMM.pdf"}
        ]
      }
    ],
    "key_findings": [
      "Two plans provide $50/month benefit increase while one provides $75/month",
      "Effective dates vary: two plans effective January 1, one effective July 1",
      "All documents are SMMs modifying existing SPDs - base SPD comparison would require additional documents"
    ],
    "completeness_assessment": "Assessment text here...",
    "recommendations": [
      "Recommendation 1...",
      "Recommendation 2..."
    ]
  },
  "comparison_spreadsheet": {
    "rows": [
      {
        "procedure_element": "Pension Benefit Increase Amount",
        "plan_values": ["$50 per month increase", "$75 per month increase", "$50 per month increase"]
      },
      {
        "procedure_element": "Benefit Increase Effective Date",
        "plan_values": ["January 1, 2021", "July 1, 2021", "January 1, 2021"]
      }
    ]
  },
  "language_comparison": {
    "rows": [
      {
        "procedure_element": "Pension Benefit Increase Amount",
        "plan_details": [
          {
            "summary": "$50 per month increase",
            "full_text": "Effective January 1, 2021, the monthly pension benefit for all retirees shall be increased by fifty dollars ($50) per month...",
            "citation": "SMM Page 2, Paragraph 1"
          },
          {
            "summary": "$75 per month increase",
            "full_text": "All participants receiving monthly pension benefits shall have their benefit amount increased by seventy-five dollars ($75) effective July 1, 2021...",
            "citation": "SMM Page 3, Paragraph 2"
          },
          {
            "summary": "$50 per month increase",
            "full_text": "The Board of Trustees has approved a benefit increase of fifty dollars ($50) per month for all retirees...",
            "citation": "SMM Page 1, Paragraph 4"
          }
        ]
      }
    ]
  }
}
\`\`\`

**JSON Output Requirements:**
1. **Valid JSON Syntax**: Must be parseable by standard JSON parsers
2. **Complete Coverage**: All detected plan units must appear in every output
3. **Consistent Ordering**: plan_units array defines order; all other arrays follow same order
4. **Array Correspondence**: plan_values and plan_details arrays must have same length and order as plan_units
5. **No Missing Data**: Use "Not specified in documents provided" if information unavailable
6. **Escape Special Characters**: Properly escape quotes, newlines
7. **NO TEXT OUTSIDE JSON**: Response must be ONLY the JSON object (no markdown, no explanations)

---

## Response Style Guidelines

**Be Direct and Precise:**
- Lead with findings, not process descriptions
- Use specific numbers and dates: "60 days" not "short period"
- State facts without hedging unless genuinely uncertain

**Flag Critical Items:**
- Use clear indicators for material differences in summary
- Prioritize provisions that restrict participant rights
- Note unusually favorable or restrictive provisions

**Maintain Professional Tone:**
- Analytical and neutral, not advocacy
- Acknowledge legitimate policy trade-offs
- Note when variations may reflect different plan demographics

**Handle Ambiguity Transparently:**
- Explicitly state when information is missing or unclear
- Distinguish between "not mentioned" vs. "explicitly not required"
- Suggest what additional documents would clarify uncertainties

**Prioritize Actionability:**
- Emphasize differences requiring decisions
- De-emphasize immaterial formatting differences
- Always explain why differences matter (impact on participants)

---

## Critical Reminders

**DO:**
- ‚úì Auto-detect plan unit names, document types, and effective dates from content
- ‚úì Build document hierarchy (SMMs override SPDs)
- ‚úì Extract complete verbatim legal language for language_comparison
- ‚úì Provide precise page and paragraph citations
- ‚úì Include ALL detected plan units in plan_units array and all outputs
- ‚úì Maintain consistent ordering (plan_units defines order for all arrays)
- ‚úì Use standardized procedure element names for consistency
- ‚úì Flag when uncertain rather than guessing
- ‚úì Output ONLY valid, parseable JSON (no other text)

**DO NOT:**
- ‚ùå Hardcode plan names - detect actual names from documents
- ‚ùå Assume specific plan units exist - only include what's actually uploaded
- ‚ùå Paraphrase or summarize legal language in language_comparison (must be verbatim)
- ‚ùå Fabricate information not present in documents
- ‚ùå Assume plans are identical because they're in same organization
- ‚ùå Provide legal advice or definitive compliance opinions
- ‚ùå Omit any detected plan units from outputs
- ‚ùå Use inconsistent array ordering (must match plan_units array)
- ‚ùå Include syntax errors in JSON output
- ‚ùå Include any text, markdown formatting, or explanations outside the JSON object

---

When the user clicks "Compare Documents", begin your three-phase analysis and respond with ONLY the JSON output.`;

    // Chat Application
    const ChatApp = {
      state: {
        messages: [],
        isStreaming: false,
        currentThinking: '',
        currentResponse: '',
        currentBlockType: null,
        abortController: null,
        uploadedFiles: [],
        filesPanelExpanded: true,
        comparisonData: null, // Stores parsed JSON from comparison
        activeTab: 'summary' // Current active tab
      },

      init() {
        this.renderInputArea();
        this.initFileUpload();
      },

      isInitialState() {
        return this.state.messages.length === 0;
      },

      renderInputArea() {
        const inputContainer = document.querySelector('.input-container');

        if (this.isInitialState()) {
          const hasFiles = this.state.uploadedFiles.filter(f => f.status === 'uploaded').length > 0;
          const isUploading = this.state.uploadedFiles.some(f => f.status === 'uploading');

          let helperText, helperClass, buttonDisabled;

          if (isUploading) {
            helperText = 'Waiting for files to finish uploading...';
            helperClass = 'warning';
            buttonDisabled = true;
          } else if (!hasFiles) {
            helperText = 'Upload plan documents above to begin comparison';
            helperClass = '';
            buttonDisabled = true;
          } else {
            helperText = 'Click to compare uploaded plan documents';
            helperClass = '';
            buttonDisabled = false;
          }

          inputContainer.innerHTML = `
            <div class="initial-prompt">
              <button
                type="button"
                id="compare-button"
                class="compare-button"
                ${buttonDisabled ? 'disabled' : ''}
              >
                Compare Documents
              </button>
              <p class="helper-text ${helperClass}" id="compare-helper">
                ${helperText}
              </p>
            </div>
          `;

          this.attachCompareButtonHandler();
        } else {
          // Normal chat input
          inputContainer.innerHTML = `
            <form class="input-form" id="chat-form">
              <textarea
                id="user-input"
                placeholder="Ask anything..."
                rows="1"
                autofocus
              ></textarea>
              <button type="submit" id="send-button">Send</button>
            </form>
          `;

          this.setupEventListeners();
          this.autoResizeTextarea();
        }
      },

      attachCompareButtonHandler() {
        const compareButton = document.getElementById('compare-button');
        if (compareButton) {
          compareButton.addEventListener('click', () => {
            if (!this.state.isStreaming && !compareButton.disabled) {
              this.sendMessage('Compare the attached plan documents.');
            }
          });
        }
      },

      setupEventListeners() {
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const message = input.value.trim();
          if (message && !this.state.isStreaming) {
            this.sendMessage(message);
            input.value = '';
            input.style.height = 'auto';
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
          }
        });

        input.addEventListener('input', () => {
          input.style.height = 'auto';
          input.style.height = Math.min(input.scrollHeight, 200) + 'px';
        });
      },

      autoResizeTextarea() {
        const input = document.getElementById('user-input');
        input.style.height = 'auto';
        input.style.height = input.scrollHeight + 'px';
      },

      addMessage(role, content, thinking = '') {
        this.state.messages.push({
          role,
          content,
          thinking
        });
        this.render();
      },

      async sendMessage(userMessage) {
        // Check if any files are still uploading
        const uploadingFiles = this.state.uploadedFiles.filter(f => f.status === 'uploading');
        if (uploadingFiles.length > 0) {
          alert('Please wait for all files to finish uploading before sending a message.');
          return;
        }

        // Track if this was the initial state
        const wasInitialState = this.isInitialState();

        // Clear empty state
        const messagesContainer = document.getElementById('messages');
        const emptyState = messagesContainer.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        // Add user message
        this.addMessage('user', userMessage);

        // Transition UI if this was the first message
        if (wasInitialState) {
          this.renderInputArea();
        }

        // Prepare messages for API (Gemini format)
        const apiContents = [];

        // Build conversation history
        for (const msg of this.state.messages) {
          if (msg.role === 'user') {
            // Build parts array for user message
            const parts = [];

            // Add all uploaded files as inline_data blocks (only for first user message)
            if (apiContents.length === 0) {
              const uploadedFiles = this.state.uploadedFiles.filter(f => f.status === 'uploaded');
              uploadedFiles.forEach(file => {
                parts.push({
                  inline_data: {
                    mime_type: file.mimeType,
                    data: file.base64Data
                  }
                });
              });
            }

            // Add user text
            parts.push({ text: msg.content });

            apiContents.push({ role: 'user', parts });
          } else {
            // For model messages, include thinking summaries if present
            const parts = [];
            if (msg.thinking) {
              parts.push({ text: msg.thinking });
            }
            parts.push({ text: msg.content });
            apiContents.push({ role: 'model', parts });
          }
        }

        // Start streaming
        this.state.isStreaming = true;
        this.state.currentThinking = '';
        this.state.currentResponse = '';
        this.state.currentBlockType = null;
        this.updateSendButton(true);

        // Create streaming message container
        this.createStreamingMessage();

        try {
          await this.streamResponse(apiContents);
        } catch (error) {
          this.handleError(error);
        } finally {
          this.state.isStreaming = false;
          this.updateSendButton(false);
        }
      },

      createStreamingMessage() {
        const messagesContainer = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant streaming';
        messageDiv.id = 'streaming-message';
        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="message-role">Assistant</span>
          </div>
          <div class="message-content">
            <div id="streaming-thinking" style="display: none;"></div>
            <div id="streaming-response"></div>
            <div class="streaming-indicator">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        `;
        messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
      },

      async streamResponse(contents) {
        this.state.abortController = new AbortController();

        const model = CONFIG.MODEL || 'gemini-2.0-flash-exp';
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?alt=sse`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': CONFIG.GEMINI_API_KEY
            },
            body: JSON.stringify({
              systemInstruction: {
                parts: [{ text: SYSTEM_PROMPT_TEXT }]
              },
              contents: contents,
              generationConfig: {
                maxOutputTokens: CONFIG.MAX_OUTPUT_TOKENS || 4096,
                temperature: 1.0
              }
            }),
            signal: this.state.abortController.signal
          }
        );

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API request failed (${response.status}): ${errorText}`);
        }

        const reader = response.body
          .pipeThrough(new TextDecoderStream())
          .getReader();

        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += value;
          const events = buffer.split(/\r?\n\r?\n/);
          buffer = events.pop() || '';

          for (const event of events) {
            if (!event.trim()) continue;

            const lines = event.split(/\r?\n/);
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const jsonData = line.slice(6);
                  const chunk = JSON.parse(jsonData);
                  this.handleStreamChunk(chunk);
                } catch (e) {
                  console.error('Parse error:', e, line);
                }
              }
            }
          }
        }

        this.finalizeStreamingMessage();
      },

      handleStreamChunk(chunk) {
        // Extract parts from the chunk
        const candidate = chunk.candidates?.[0];
        if (!candidate || !candidate.content || !candidate.content.parts) return;

        for (const part of candidate.content.parts) {
          if (part.thought) {
            // This is a thinking summary
            this.state.currentThinking += part.text || '';
            this.updateStreamingThinking();
          } else if (part.text) {
            // This is the main response
            this.state.currentResponse += part.text;
            this.updateStreamingResponse();
          }
        }

        // Check if thinking is done (finishReason indicates completion)
        if (candidate.finishReason && this.state.currentThinking && !this.state.thinkingCollapsed) {
          this.collapseStreamingThinking();
          this.state.thinkingCollapsed = true;
        }
      },

      updateStreamingThinking() {
        const thinkingDiv = document.getElementById('streaming-thinking');
        if (thinkingDiv && this.state.currentThinking) {
          thinkingDiv.style.display = 'block';
          const thinkingId = 'thinking-streaming';
          thinkingDiv.innerHTML = `
            <div class="thinking-block">
              <div class="thinking-header" onclick="ChatApp.toggleThinking('${thinkingId}')">
                <span>Thinking</span>
                <span class="thinking-toggle" id="${thinkingId}-toggle">Hide</span>
              </div>
              <div class="thinking-content" id="${thinkingId}">
                ${this.escapeHtml(this.state.currentThinking)}
              </div>
            </div>
          `;
        }
      },

      collapseStreamingThinking() {
        const thinkingContent = document.getElementById('thinking-streaming');
        const thinkingToggle = document.getElementById('thinking-streaming-toggle');
        if (thinkingContent && thinkingToggle) {
          thinkingContent.classList.add('collapsed');
          thinkingToggle.textContent = 'Show';
        }
      },

      updateStreamingResponse() {
        const responseDiv = document.getElementById('streaming-response');
        if (responseDiv) {
          responseDiv.innerHTML = marked.parse(this.state.currentResponse);
          this.scrollToBottom();
        }
      },

      finalizeStreamingMessage() {
        const streamingMessage = document.getElementById('streaming-message');
        if (streamingMessage) {
          streamingMessage.remove();
        }

        // Try to parse as JSON and render outputs
        try {
          this.parseAndRenderOutputs(this.state.currentResponse);
        } catch (error) {
          // If JSON parsing fails, fall back to regular message display
          console.error('Not JSON response, falling back to message display:', error);
          this.addMessage('model', this.state.currentResponse, this.state.currentThinking);
          this.render();
        }

        // Reset streaming state
        this.state.currentThinking = '';
        this.state.currentResponse = '';
        this.state.thinkingCollapsed = false;
      },

      toggleThinking(id) {
        const content = document.getElementById(id);
        const toggle = document.getElementById(id + '-toggle');
        if (content && toggle) {
          content.classList.toggle('collapsed');
          toggle.textContent = content.classList.contains('collapsed') ? 'Show' : 'Hide';
        }
      },

      render() {
        const messagesContainer = document.getElementById('messages');
        const streamingMessage = document.getElementById('streaming-message');

        // Don't re-render if streaming
        if (streamingMessage) return;

        // Clear and rebuild (except streaming message)
        const messages = this.state.messages.map((msg, index) => {
          const thinking = msg.thinking || '';
          const thinkingId = `thinking-${index}`;

          if (msg.role === 'user') {
            return `
              <div class="message user">
                <div class="message-header">
                  <span class="message-role">You</span>
                </div>
                <div class="message-content">
                  ${this.escapeHtml(msg.content)}
                </div>
              </div>
            `;
          } else {
            return `
              <div class="message assistant">
                <div class="message-header">
                  <span class="message-role">Assistant</span>
                </div>
                <div class="message-content">
                  ${thinking ? `
                    <div class="thinking-block">
                      <div class="thinking-header" onclick="ChatApp.toggleThinking('${thinkingId}')">
                        <span>Thinking</span>
                        <span class="thinking-toggle" id="${thinkingId}-toggle">Show</span>
                      </div>
                      <div class="thinking-content collapsed" id="${thinkingId}">
                        ${this.escapeHtml(thinking)}
                      </div>
                    </div>
                  ` : ''}
                  <div class="response-text">
                    ${marked.parse(msg.content)}
                  </div>
                </div>
              </div>
            `;
          }
        }).join('');

        messagesContainer.innerHTML = messages;
        this.scrollToBottom();
      },

      handleError(error) {
        console.error('Chat error:', error);

        const streamingMessage = document.getElementById('streaming-message');
        if (streamingMessage) {
          streamingMessage.remove();
        }

        // If this was the first message and it failed, revert to initial state
        if (this.state.messages.length === 1 && this.state.messages[0].role === 'user') {
          this.state.messages = []; // Clear the failed attempt
          this.renderInputArea(); // Show Compare button again
        }

        const messagesContainer = document.getElementById('messages');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message assistant';
        errorDiv.innerHTML = `
          <div class="message-header">
            <span class="message-role">Error</span>
          </div>
          <div class="message-content">
            <div class="error-message">
              <strong>Error:</strong> ${this.escapeHtml(error.message)}
              ${this.state.messages.length === 0 ? '<br><small>Try clicking "Compare Documents" again.</small>' : ''}
            </div>
          </div>
        `;
        messagesContainer.appendChild(errorDiv);
        this.scrollToBottom();
      },

      updateSendButton(disabled) {
        const button = document.getElementById('send-button');
        if (button) {
          button.disabled = disabled;
          button.textContent = disabled ? 'Sending...' : 'Send';
        }
      },

      scrollToBottom() {
        const container = document.getElementById('messages');
        container.scrollTop = container.scrollHeight;
      },

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      // File Upload Functions
      initFileUpload() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        // Click to browse
        dropZone.addEventListener('click', () => {
          fileInput.click();
        });

        // File selection
        fileInput.addEventListener('change', (e) => {
          this.handleFileSelect(e.target.files);
          fileInput.value = ''; // Reset input
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => this.handleDragOver(e));
        dropZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        dropZone.addEventListener('drop', (e) => this.handleDrop(e));
      },

      toggleFilesPanel() {
        this.state.filesPanelExpanded = !this.state.filesPanelExpanded;
        const content = document.getElementById('files-content');
        const toggle = document.getElementById('files-toggle');

        if (this.state.filesPanelExpanded) {
          content.classList.remove('collapsed');
          toggle.classList.remove('collapsed');
          toggle.textContent = '‚ñº';
        } else {
          content.classList.add('collapsed');
          toggle.classList.add('collapsed');
          toggle.textContent = '‚ñ∂';
        }
      },

      handleFileSelect(files) {
        if (files.length === 0) return;

        Array.from(files).forEach(file => {
          this.uploadFile(file);
        });
      },

      handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        const dropZone = document.getElementById('drop-zone');
        dropZone.classList.add('dragging');
      },

      handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        const dropZone = document.getElementById('drop-zone');
        if (e.target === dropZone) {
          dropZone.classList.remove('dragging');
        }
      },

      handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        const dropZone = document.getElementById('drop-zone');
        dropZone.classList.remove('dragging');

        const files = e.dataTransfer.files;
        this.handleFileSelect(files);
      },

      async uploadFile(file) {
        // Validate file size (20 MB limit for inline base64)
        const maxSize = 20 * 1024 * 1024; // 20 MB in bytes
        if (file.size > maxSize) {
          alert(`File "${file.name}" is too large. Maximum size is 20 MB per file for inline upload.`);
          return;
        }

        // Create temporary file card
        const tempId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const fileObj = {
          id: tempId,
          filename: file.name,
          size: file.size,
          mimeType: file.type || 'application/pdf',
          status: 'uploading',
          uploadedAt: new Date().toISOString(),
          base64Data: null
        };

        this.state.uploadedFiles.push(fileObj);
        this.renderFilesList();
        this.updateFilesCount();

        try {
          // Read file as base64
          const base64Data = await this.readFileAsBase64(file);

          // Update file object with base64 data
          const fileIndex = this.state.uploadedFiles.findIndex(f => f.id === tempId);
          if (fileIndex !== -1) {
            this.state.uploadedFiles[fileIndex].base64Data = base64Data;
            this.state.uploadedFiles[fileIndex].status = 'uploaded';
          }

          this.renderFilesList();
          this.renderInputArea(); // Update button state

        } catch (error) {
          console.error('Upload error:', error);

          // Mark file as error
          const fileIndex = this.state.uploadedFiles.findIndex(f => f.id === tempId);
          if (fileIndex !== -1) {
            this.state.uploadedFiles[fileIndex].status = 'error';
            this.state.uploadedFiles[fileIndex].error = error.message;
          }

          this.renderFilesList();
          this.renderInputArea(); // Update button state
          alert(`Failed to load "${file.name}": ${error.message}`);
        }
      },

      readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = () => {
            // Remove the data URL prefix (e.g., "data:application/pdf;base64,")
            const base64String = reader.result.split(',')[1];
            resolve(base64String);
          };

          reader.onerror = () => {
            reject(new Error('Failed to read file'));
          };

          reader.readAsDataURL(file);
        });
      },

      removeFile(fileId) {
        // Remove from state (base64 data is stored locally, no API cleanup needed)
        this.state.uploadedFiles = this.state.uploadedFiles.filter(f => f.id !== fileId);
        this.renderFilesList();
        this.updateFilesCount();
        this.renderInputArea(); // Update button state
      },

      renderFilesList() {
        const filesList = document.getElementById('files-list');

        if (this.state.uploadedFiles.length === 0) {
          filesList.innerHTML = '';
          return;
        }

        filesList.innerHTML = this.state.uploadedFiles.map(file => {
          const icon = this.getFileIcon(file.mimeType);
          const statusClass = file.status;
          const statusText = file.status === 'uploading' ? 'Uploading...' :
                            file.status === 'uploaded' ? '‚úì Uploaded' :
                            '‚úó Error';

          return `
            <div class="file-card ${statusClass}">
              <div class="file-icon">${icon}</div>
              <div class="file-info">
                <div class="file-name">${this.escapeHtml(file.filename)}</div>
                <div class="file-meta">
                  <span class="file-size">${this.formatFileSize(file.size)}</span>
                  <span class="file-status ${statusClass}">${statusText}</span>
                </div>
              </div>
              <button class="file-remove" onclick="ChatApp.removeFile('${file.id}')" title="Remove file">
                √ó
              </button>
            </div>
          `;
        }).join('');
      },

      updateFilesCount() {
        const count = this.state.uploadedFiles.length;
        const filesCount = document.getElementById('files-count');
        filesCount.textContent = `(${count} ${count === 1 ? 'file' : 'files'})`;
      },

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 10) / 10 + ' ' + sizes[i];
      },

      getFileIcon(mimeType) {
        if (!mimeType) return 'üìÑ';

        if (mimeType.includes('pdf')) return 'üìï';
        if (mimeType.includes('image')) return 'üñºÔ∏è';
        if (mimeType.includes('word') || mimeType.includes('document')) return 'üìò';
        if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || mimeType.includes('csv')) return 'üìä';
        if (mimeType.includes('text')) return 'üìù';

        return 'üìÑ';
      },

      // ===== NEW: Three-Output Tab System =====

      switchTab(tabName) {
        // Update active tab state
        this.state.activeTab = tabName;

        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');
      },

      parseAndRenderOutputs(jsonResponse) {
        try {
          // Clean and extract JSON from response
          let cleanJson = jsonResponse.trim();

          // Remove markdown code fences if present
          if (cleanJson.startsWith('```json')) {
            cleanJson = cleanJson.replace(/^```json\s*/i, '').replace(/\s*```\s*$/, '');
          } else if (cleanJson.startsWith('```')) {
            cleanJson = cleanJson.replace(/^```\s*/, '').replace(/\s*```\s*$/, '');
          }

          // Try to extract JSON object if there's extra text
          const jsonMatch = cleanJson.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            cleanJson = jsonMatch[0];
          }

          console.log('Attempting to parse JSON:', cleanJson.substring(0, 200) + '...');

          // Parse JSON response
          const data = JSON.parse(cleanJson);
          this.state.comparisonData = data;

          // Hide messages container, show output tabs
          document.getElementById('messages').style.display = 'none';
          document.getElementById('output-tabs').classList.add('active');

          // Render each output
          this.renderSummary(data.summary);
          this.renderComparisonSpreadsheet(data.comparison_spreadsheet, data.plan_units);
          this.renderLanguageComparison(data.language_comparison, data.plan_units);

        } catch (error) {
          console.error('Failed to parse JSON response:', error);
          console.error('Raw response:', jsonResponse.substring(0, 500));
          this.handleError(new Error('Failed to parse comparison results. Please try again.'));
        }
      },

      renderSummary(summaryData) {
        const output = document.getElementById('summary-output');

        let markdown = '## Document Inventory\n\n';
        summaryData.document_inventory.forEach(unit => {
          markdown += `### ${unit.plan_unit}\n`;
          unit.documents.forEach(doc => {
            markdown += `- **${doc.type}** (Effective: ${doc.effective_date}) - ${doc.filename}\n`;
          });
          markdown += '\n';
        });

        markdown += '## Key Findings\n\n';
        summaryData.key_findings.forEach(finding => {
          markdown += `- ${finding}\n`;
        });

        markdown += '\n## Completeness Assessment\n\n';
        markdown += summaryData.completeness_assessment + '\n\n';

        markdown += '## Recommendations\n\n';
        summaryData.recommendations.forEach(rec => {
          markdown += `- ${rec}\n`;
        });

        output.innerHTML = marked.parse(markdown);
      },

      renderComparisonSpreadsheet(spreadsheetData, planUnits) {
        const output = document.getElementById('comparison-output');

        let html = '<table class="comparison-table"><thead><tr>';

        // Headers: Procedure Element + all plan units
        html += '<th>Procedure Element</th>';
        planUnits.forEach(planName => {
          html += `<th>${this.escapeHtml(planName)}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Rows: Iterate through procedure elements
        spreadsheetData.rows.forEach(row => {
          html += '<tr>';
          html += `<td>${this.escapeHtml(row.procedure_element)}</td>`;

          // Add value for each plan (should match planUnits array order)
          row.plan_values.forEach(value => {
            html += `<td>${this.escapeHtml(value || 'Not specified')}</td>`;
          });

          html += '</tr>';
        });

        html += '</tbody></table>';
        output.innerHTML = html;
      },

      renderLanguageComparison(languageData, planUnits) {
        const output = document.getElementById('language-output');

        let html = '';
        languageData.rows.forEach(row => {
          html += `<div class="language-row">`;
          html += `<div class="language-row-header">${this.escapeHtml(row.procedure_element)}</div>`;

          // Iterate through plan_details array, using planUnits for names
          row.plan_details.forEach((details, index) => {
            const planName = planUnits[index] || `Plan ${index + 1}`;

            html += `<div class="plan-language">`;
            html += `<div class="plan-name">${this.escapeHtml(planName)}</div>`;
            html += `<div class="plan-summary">${this.escapeHtml(details.summary)}</div>`;
            html += `<div class="plan-full-text">${this.escapeHtml(details.full_text)}</div>`;
            html += `<div class="plan-citation">${this.escapeHtml(details.citation)}</div>`;
            html += `</div>`;
          });

          html += `</div>`;
        });

        output.innerHTML = html;
      },

      // ===== Excel Download Functions =====

      downloadSummary() {
        if (!this.state.comparisonData) return;

        const summaryData = this.state.comparisonData.summary;
        let markdown = '# SPD Comparison Summary\n\n';

        markdown += '## Document Inventory\n\n';
        summaryData.document_inventory.forEach(unit => {
          markdown += `### ${unit.plan_unit}\n`;
          unit.documents.forEach(doc => {
            markdown += `- **${doc.type}** (Effective: ${doc.effective_date}) - ${doc.filename}\n`;
          });
          markdown += '\n';
        });

        markdown += '## Key Findings\n\n';
        summaryData.key_findings.forEach(finding => {
          markdown += `- ${finding}\n`;
        });

        markdown += '\n## Completeness Assessment\n\n';
        markdown += summaryData.completeness_assessment + '\n\n';

        markdown += '## Recommendations\n\n';
        summaryData.recommendations.forEach(rec => {
          markdown += `- ${rec}\n`;
        });

        // Download as .md file
        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'SPD_Comparison_Summary.md';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      downloadComparisonSpreadsheet() {
        if (!this.state.comparisonData) return;

        const data = this.state.comparisonData.comparison_spreadsheet;
        const planUnits = this.state.comparisonData.plan_units;

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Convert to array format for XLSX
        const wsData = [];

        // Add headers: Procedure Element + all plan units
        const headers = ['Procedure Element', ...planUnits];
        wsData.push(headers);

        // Add data rows
        data.rows.forEach(row => {
          const rowData = [row.procedure_element, ...row.plan_values.map(v => v || 'Not specified')];
          wsData.push(rowData);
        });

        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Set column widths dynamically
        const colWidths = [{ wch: 30 }]; // Procedure Element
        planUnits.forEach(() => colWidths.push({ wch: 25 })); // Each plan
        ws['!cols'] = colWidths;

        // Freeze first row
        ws['!freeze'] = { xSplit: 0, ySplit: 1 };

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Procedure Comparison');

        // Download
        XLSX.writeFile(wb, 'SPD_Comparison_Spreadsheet.xlsx');
      },

      downloadLanguageComparison() {
        if (!this.state.comparisonData) return;

        const data = this.state.comparisonData.language_comparison;
        const planUnits = this.state.comparisonData.plan_units;

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Convert to array format
        const wsData = [];

        // Add headers
        wsData.push(['Procedure Element', 'Plan Unit', 'Summary', 'Full Text', 'Citation']);

        // Add data rows
        data.rows.forEach(row => {
          row.plan_details.forEach((details, index) => {
            const planName = planUnits[index] || `Plan ${index + 1}`;

            wsData.push([
              row.procedure_element,
              planName,
              details.summary,
              details.full_text,
              details.citation
            ]);
          });
          // Add empty row between procedure elements
          wsData.push(['', '', '', '', '']);
        });

        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Set column widths
        ws['!cols'] = [
          { wch: 30 }, // Procedure Element
          { wch: 20 }, // Plan Unit
          { wch: 30 }, // Summary
          { wch: 80 }, // Full Text (wide for legal language)
          { wch: 25 }  // Citation
        ];

        // Freeze first row
        ws['!freeze'] = { xSplit: 0, ySplit: 1 };

        // Enable text wrapping for full text column
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = 1; R <= range.e.r; ++R) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: 3 }); // Column D (Full Text)
          if (ws[cellAddress]) {
            if (!ws[cellAddress].s) ws[cellAddress].s = {};
            ws[cellAddress].s.alignment = { wrapText: true, vertical: 'top' };
          }
        }

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Language Comparison');

        // Download
        XLSX.writeFile(wb, 'SPD_Language_Comparison.xlsx');
      }
    };

    // Check if config is loaded
    if (typeof CONFIG === 'undefined' || !CONFIG.GEMINI_API_KEY) {
      document.body.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <h2 style="color: var(--error);">Configuration Error</h2>
          <p>Please create a <code>config-gemini.js</code> file with your Gemini API key.</p>
          <p>See <code>config-gemini.example.js</code> for template.</p>
        </div>
      `;
    } else {
      // Initialize app
      ChatApp.init();
    }
  </script>
</body>
</html>
