<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPD Plan Comparison Agent - Gemini</title>

  <!-- External Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script>

  <!-- Excel Generation Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Modern Tech-Forward Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Light Modern Monochrome Palette */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #f1f3f5;
      --surface-glass: rgba(255, 255, 255, 0.8);
      --surface-elevated: rgba(0, 0, 0, 0.02);

      /* Subtle Monochrome Gradients */
      --gradient-primary: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);
      --gradient-accent: linear-gradient(135deg, #2d2d2d 0%, #5a5a5a 100%);
      --gradient-success: linear-gradient(135deg, #333333 0%, #666666 100%);
      --gradient-border: linear-gradient(135deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.12));

      /* Text Colors */
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-muted: #999999;

      /* Accent Colors - Minimal */
      --accent-dark: #2d2d2d;
      --accent-gray: #5a5a5a;
      --accent-light: #8a8a8a;
      --accent-success: #4a4a4a;

      /* Borders */
      --border-subtle: rgba(0, 0, 0, 0.06);
      --border-medium: rgba(0, 0, 0, 0.12);

      /* Shadows */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
      --shadow-glow: 0 0 40px rgba(0, 0, 0, 0.1);

      /* Error */
      --error: #d32f2f;
      --error-bg: rgba(211, 47, 47, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Subtle animated background pattern */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 50%, rgba(0, 0, 0, 0.02) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.03) 0%, transparent 50%);
      animation: backgroundShift 20s ease infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(5%, -5%) rotate(120deg); }
      66% { transform: translate(-5%, 5%) rotate(240deg); }
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 100%;
      margin: 0 auto;
      padding: 0;
      position: relative;
      z-index: 1;
    }

    /* Modern Header with Asymmetric Design */
    .chat-header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--border-medium);
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      box-shadow: var(--shadow-sm);
    }

    .chat-header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient-border);
    }

    .chat-header h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .model-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--surface-elevated);
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .model-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gradient-border);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .model-badge:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .model-badge:hover::before {
      opacity: 0.1;
    }

    /* API Key Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .modal {
      background: var(--bg-primary);
      border: 1px solid var(--border-medium);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-xl);
    }

    .modal h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .modal p {
      color: var(--text-secondary);
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    .modal label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .modal input[type="text"],
    .modal input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-medium);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }

    .modal input:focus {
      outline: none;
      border-color: var(--text-primary);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .modal-button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-button.primary {
      background: var(--gradient-primary);
      color: white;
    }

    .modal-button.primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .modal-button.secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-medium);
    }

    .modal-button.secondary:hover {
      background: var(--surface-glass);
    }

    .api-key-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .api-key-hint a {
      color: var(--text-primary);
      text-decoration: underline;
    }

    .thinking-indicator-badge {
      background: var(--text-primary);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      z-index: 1;
    }

    /* Messages Area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
      scroll-behavior: smooth;
      position: relative;
    }

    /* Custom Scrollbar */
    .messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .message {
      margin-bottom: 32px;
      animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .message-role {
      position: relative;
      padding-left: 16px;
    }

    .message-role::before {
      content: '‚óè';
      position: absolute;
      left: 0;
      color: var(--text-primary);
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .message.user .message-role::before {
      color: var(--text-secondary);
    }

    /* Glass Morphism Message Cards */
    .message-content {
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .message-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .message-content:hover {
      border-color: rgba(0, 0, 0, 0.2);
      box-shadow: var(--shadow-lg);
    }

    .message-content:hover::before {
      opacity: 1;
    }

    .message.user .message-content {
      background: rgba(0, 0, 0, 0.02);
      border-color: rgba(0, 0, 0, 0.15);
    }

    .message.user .message-content::before {
      background: var(--gradient-success);
    }

    /* Thinking Block with Tech Aesthetic */
    .thinking-block {
      background: rgba(0, 0, 0, 0.02);
      border-left: 3px solid var(--text-primary);
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 12px;
      font-family: 'JetBrains Mono', Monaco, monospace;
      font-size: 13px;
      color: var(--text-secondary);
      position: relative;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .thinking-block::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(0, 0, 0, 0.01) 50%,
        transparent 100%);
      pointer-events: none;
    }

    .thinking-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      font-weight: 700;
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 11px;
      transition: all 0.2s ease;
    }

    .thinking-header:hover {
      color: var(--text-secondary);
    }

    .thinking-toggle {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      border: 1px solid var(--border-medium);
      transition: all 0.2s ease;
    }

    .thinking-toggle:hover {
      background: rgba(0, 0, 0, 0.08);
      color: var(--text-primary);
    }

    .thinking-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: left;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .thinking-content.collapsed {
      display: none;
    }

    /* Response Text Styling */
    .response-text {
      line-height: 1.8;
      color: var(--text-primary);
    }

    .response-text p {
      margin-bottom: 16px;
    }

    .response-text p:last-child {
      margin-bottom: 0;
    }

    .response-text code {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-family: 'JetBrains Mono', Monaco, monospace;
      border: 1px solid var(--border-medium);
    }

    .response-text pre {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 16px 0;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .response-text pre code {
      background: none;
      padding: 0;
      border: none;
      color: var(--text-secondary);
    }

    .response-text ul, .response-text ol {
      margin-left: 24px;
      margin-bottom: 16px;
    }

    .response-text li {
      margin-bottom: 8px;
    }

    .response-text blockquote {
      border-left: 3px solid var(--text-primary);
      padding-left: 16px;
      margin: 16px 0;
      color: var(--text-secondary);
      background: rgba(0, 0, 0, 0.03);
      padding: 12px 12px 12px 16px;
      border-radius: 8px;
    }

    .response-text h1, .response-text h2, .response-text h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      margin-top: 24px;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .response-text a {
      color: var(--text-primary);
      text-decoration: none;
      border-bottom: 2px solid var(--text-primary);
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .response-text a:hover {
      color: var(--text-secondary);
      border-bottom-color: var(--text-secondary);
    }

    /* Streaming Indicator */
    .streaming-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
    }

    .streaming-indicator .dot {
      width: 8px;
      height: 8px;
      background: var(--text-primary);
      border-radius: 50%;
      animation: dotPulse 1.4s ease-in-out infinite;
    }

    .streaming-indicator .dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .streaming-indicator .dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes dotPulse {
      0%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* Modern Input Area */
    .input-container {
      border-top: 1px solid var(--border-medium);
      padding: 24px 32px;
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      position: relative;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.2);
    }

    .input-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient-border);
    }

    .input-form {
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }

    #user-input {
      flex: 1;
      min-height: 56px;
      max-height: 200px;
      padding: 16px 20px;
      border: 2px solid var(--border-medium);
      border-radius: 12px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      resize: none;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    #user-input::placeholder {
      color: var(--text-muted);
    }

    #user-input:focus {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05), var(--shadow-md);
      background: var(--bg-tertiary);
    }

    /* Monochrome Button with Animation */
    #send-button {
      padding: 16px 32px;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
      font-family: 'Space Grotesk', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }

    #send-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    #send-button:hover:not(:disabled)::before {
      left: 100%;
    }

    #send-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: var(--text-secondary);
    }

    #send-button:active:not(:disabled) {
      transform: translateY(0);
    }

    #send-button:disabled {
      background: var(--surface-elevated);
      color: var(--text-muted);
      cursor: not-allowed;
      box-shadow: none;
      border: 1px solid var(--border-medium);
    }

    /* Error Styling */
    .error-message {
      background: var(--error-bg);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 16px 20px;
      border-radius: 12px;
      margin: 16px 0;
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      box-shadow: 0 4px 16px rgba(255, 107, 107, 0.2);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 32px;
      color: var(--text-secondary);
    }

    .empty-state h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px;
      margin-bottom: 16px;
      color: var(--text-primary);
      font-weight: 700;
    }

    .empty-state p {
      font-size: 16px;
      color: var(--text-muted);
    }

    /* Plan Docs File Upload Section - Modern Design */
    .files-section {
      border-bottom: 1px solid var(--border-medium);
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      position: relative;
    }

    .files-section::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient-border);
    }

    .files-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
    }

    .files-header:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .files-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
      letter-spacing: 0.5px;
    }

    .files-icon {
      font-size: 20px;
    }

    .files-count {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
      font-family: 'JetBrains Mono', monospace;
    }

    .files-toggle {
      font-size: 14px;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }

    .files-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .files-content {
      padding: 24px 32px 28px;
      max-height: 500px;
      overflow-y: auto;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }

    .files-content::-webkit-scrollbar {
      width: 6px;
    }

    .files-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .files-content::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 3px;
    }

    .files-content.collapsed {
      max-height: 0;
      padding: 0 32px;
      overflow: hidden;
    }

    /* Modern Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-medium);
      border-radius: 16px;
      padding: 48px 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      position: relative;
      overflow: hidden;
    }

    .drop-zone::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gradient-border);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .drop-zone:hover {
      border-color: var(--text-primary);
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-md);
    }

    .drop-zone:hover::before {
      opacity: 0.05;
    }

    .drop-zone.dragging {
      border-color: var(--text-primary);
      background: rgba(0, 0, 0, 0.04);
      border-width: 3px;
      box-shadow: var(--shadow-glow);
    }

    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.7;
    }

    .drop-zone-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: 'Space Grotesk', sans-serif;
    }

    .drop-zone-hint {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
      font-family: 'JetBrains Mono', monospace;
    }

    .files-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Modern File Cards */
    .file-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
      animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      overflow: hidden;
    }

    .file-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .file-card:hover {
      border-color: var(--text-primary);
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }

    .file-card:hover::before {
      opacity: 1;
    }

    .file-card.uploading {
      opacity: 0.7;
      animation: pulse 2s ease infinite;
    }

    .file-card.error {
      border-color: var(--error);
      background: var(--error-bg);
    }

    .file-card.error::before {
      background: var(--error);
      opacity: 1;
    }

    .file-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      word-break: break-all;
      line-height: 1.5;
    }

    .file-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-family: 'JetBrains Mono', monospace;
    }

    .file-size {
      display: inline-flex;
      align-items: center;
    }

    .file-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .file-status.uploaded {
      color: var(--text-primary);
    }

    .file-status.uploading {
      color: var(--text-secondary);
    }

    .file-status.error {
      color: var(--error);
    }

    .file-remove {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .file-remove:hover {
      background: var(--error);
      color: white;
      border-color: var(--error);
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }

    /* Initial Compare Button UI - Hero Style */
    .initial-prompt {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .compare-button {
      width: 100%;
      max-width: 500px;
      padding: 20px 48px;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      font-family: 'Space Grotesk', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .compare-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .compare-button:hover:not(:disabled)::before {
      width: 300px;
      height: 300px;
    }

    .compare-button:hover:not(:disabled) {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--shadow-lg);
      background: var(--text-secondary);
    }

    .compare-button:active:not(:disabled) {
      transform: translateY(-2px) scale(1);
    }

    .compare-button:disabled {
      background: var(--surface-elevated);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      border: 1px solid var(--border-medium);
    }

    .compare-button.comparing {
      background: var(--text-secondary);
      animation: pulse 2s ease infinite;
    }

    .helper-text {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin: 0;
      font-family: 'JetBrains Mono', monospace;
    }

    .helper-text.warning {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Tab Interface for Three Outputs */
    .output-tabs {
      display: none; /* Hidden until comparison completes */
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .output-tabs.active {
      display: flex;
    }

    .tabs-header {
      display: flex;
      border-bottom: 2px solid var(--border-medium);
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      padding: 0 32px;
      gap: 8px;
    }

    .tab-button {
      padding: 16px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      position: relative;
    }

    .tab-button:hover {
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-button.active {
      color: var(--text-primary);
      border-bottom-color: var(--text-primary);
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    .tab-content.active {
      display: block;
    }

    .tab-content::-webkit-scrollbar {
      width: 8px;
    }

    .tab-content::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .tab-content::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 4px;
    }

    /* Output Specific Styles */
    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-medium);
    }

    .output-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .download-button {
      padding: 12px 24px;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .download-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: var(--text-secondary);
    }

    /* Summary Output Styles */
    .summary-content {
      font-size: 15px;
      line-height: 1.8;
    }

    .summary-content h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin: 24px 0 12px 0;
      color: var(--text-primary);
    }

    .summary-content h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 10px 0;
      color: var(--text-secondary);
    }

    .summary-content ul {
      margin-left: 24px;
      margin-bottom: 16px;
    }

    .summary-content li {
      margin-bottom: 8px;
    }

    /* Table Styles for Spreadsheet Outputs */
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-primary);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      margin-top: 16px;
    }

    .comparison-table thead {
      background: var(--gradient-primary);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .comparison-table th {
      padding: 16px;
      text-align: left;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comparison-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 14px;
      vertical-align: top;
    }

    .comparison-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .comparison-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* First column (procedure element) styling */
    .comparison-table td:first-child {
      font-weight: 600;
      color: var(--text-primary);
      background: var(--bg-secondary);
      position: sticky;
      left: 0;
      z-index: 5;
    }

    /* Language Comparison Specific Styles */
    .language-row {
      margin-bottom: 40px;
      padding: 24px;
      background: var(--surface-glass);
      border-radius: 12px;
      border: 1px solid var(--border-medium);
    }

    .language-row-header {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-medium);
    }

    .plan-language {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 8px;
      border-left: 3px solid var(--text-primary);
    }

    .plan-language:last-child {
      margin-bottom: 0;
    }

    .plan-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: 'Space Grotesk', sans-serif;
    }

    .plan-summary {
      font-size: 13px;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 12px;
    }

    .plan-full-text {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-primary);
      margin-bottom: 10px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
    }

    .plan-citation {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Table borders for markdown-rendered tables in output tabs */
    .tab-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 16px 0;
    }

    .tab-content table th,
    .tab-content table td {
      border: 1px solid var(--border-subtle);
      padding: 12px;
      text-align: left;
    }

    .tab-content table th {
      background: var(--bg-secondary);
      font-weight: 600;
      color: var(--text-primary);
    }

    .tab-content table tr:hover {
      background: var(--bg-secondary);
    }

    /* Loading Indicator for Comparison (in messages area) */
    .comparison-loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 32px;
      gap: 24px;
      min-height: 300px;
    }

    .comparison-loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border-subtle);
      border-top-color: var(--text-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .comparison-loading-text {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .comparison-loading-phase {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      max-width: 500px;
    }

    .comparison-progress-dots {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border-subtle);
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background: var(--text-primary);
      transform: scale(1.3);
    }

    /* Split View Layout for Chat (Permanent Sidebar) */
    .split-view {
      display: none; /* Hidden by default */
      position: fixed;
      right: 0;
      top: 140px; /* Below header */
      height: calc(100vh - 140px);
      width: 48px; /* Start with collapsed width */
      z-index: 100;
      transition: width 0.3s ease;
    }

    .split-view.active {
      display: flex;
      flex-direction: row;
    }

    .split-view.expanded {
      width: 400px; /* Expanded width - grows leftward from right: 0 anchor */
    }

    /* Hide results-panel initially - only show when expanded with resize */
    .split-view .results-panel {
      display: none;
    }

    /* Show resize handle only when chat is expanded */
    .split-view .resize-handle {
      display: none;
    }

    .split-view.expanded .resize-handle {
      display: flex;
    }

    /* Adjust output-tabs to make room for collapsed chat sidebar */
    .output-tabs.active {
      margin-right: 52px; /* Room for collapsed chat (48px + 4px gap) */
    }

    .output-tabs.chat-expanded {
      margin-right: 404px; /* Room for expanded chat (400px + 4px gap) */
    }

    /* Chat panel sizing */
    .split-view .chat-panel {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Hide main chat content when collapsed */
    .split-view .chat-panel.collapsed .chat-messages-container,
    .split-view .chat-panel.collapsed .chat-input-area {
      display: none;
    }

    .results-panel {
      flex: 0 0 40%;
      border-right: 1px solid var(--border-medium);
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
      overflow: hidden;
    }

    .mini-tabs {
      display: flex;
      gap: 4px;
      padding: 12px;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--bg-tertiary);
      flex-shrink: 0;
    }

    .mini-tab {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Space Grotesk', sans-serif;
    }

    .mini-tab:hover {
      background: var(--surface-glass);
      color: var(--text-primary);
      border-color: var(--border-medium);
    }

    .mini-tab.active {
      background: var(--text-primary);
      color: white;
      border-color: var(--text-primary);
    }

    .mini-output-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--bg-primary);
    }

    .mini-output-content::-webkit-scrollbar {
      width: 6px;
    }

    .mini-output-content::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .mini-output-content::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 3px;
    }

    /* Chat Panel Styles */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      overflow: hidden;
    }

    .chat-messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chat-messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-messages-container::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .chat-messages-container::-webkit-scrollbar-thumb {
      background: var(--surface-elevated);
      border-radius: 4px;
    }

    .chat-message {
      animation: slideInUp 0.3s ease;
    }

    .chat-message.user {
      align-self: flex-end;
      max-width: 80%;
    }

    .chat-message.assistant {
      align-self: flex-start;
      max-width: 90%;
    }

    .chat-message-header {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }

    .chat-message-content {
      background: var(--surface-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .chat-message.user .chat-message-content {
      background: rgba(0, 0, 0, 0.02);
      border-color: rgba(0, 0, 0, 0.15);
    }

    .chat-message-content:hover {
      box-shadow: var(--shadow-md);
      border-color: rgba(0, 0, 0, 0.2);
    }

    .chat-input-area {
      padding: 16px 20px;
      border-top: 1px solid var(--border-medium);
      background: var(--bg-secondary);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    #chat-input {
      flex: 1;
      min-height: 44px;
      max-height: 150px;
      padding: 12px 16px;
      border: 1px solid var(--border-medium);
      border-radius: 10px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      transition: all 0.2s ease;
    }

    #chat-input:focus {
      outline: none;
      border-color: var(--text-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    #chat-input::placeholder {
      color: var(--text-muted);
    }

    #chat-send-button {
      padding: 12px 24px;
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      white-space: nowrap;
    }

    #chat-send-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: var(--gradient-accent);
    }

    #chat-send-button:disabled {
      background: var(--surface-elevated);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    .chat-streaming-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }

    .chat-streaming-indicator .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: dotPulse 1.4s ease-in-out infinite;
    }

    .chat-streaming-indicator .dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .chat-streaming-indicator .dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    .tab-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Coming Soon Tab Styling */
    .coming-soon-tab {
      color: #ff8c42 !important;
      border-bottom-color: #ffd4b3 !important;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .coming-soon-tab:hover {
      color: #ff9e5f !important;
      border-bottom-color: #ffe0c7 !important;
    }

    /* Resize Handle for Split View */
    .resize-handle {
      flex: 0 0 4px;
      background: var(--bg-secondary);
      cursor: col-resize;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .resize-handle:hover {
      background: var(--border-medium);
    }

    .resize-handle-line {
      width: 1px;
      height: 40px;
      background: var(--text-muted);
      border-radius: 2px;
      transition: background 0.2s ease;
    }

    .resize-handle:hover .resize-handle-line {
      background: var(--text-primary);
    }

    .resizing {
      cursor: col-resize !important;
      user-select: none;
    }

    .collapse-button {
      position: absolute;
      top: 12px;
      left: 8px;
      width: 32px;
      height: 32px;
      background: var(--surface-glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-medium);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
      transition: all 0.2s ease;
      z-index: 1000;
    }

    .collapse-button:hover {
      background: var(--text-primary);
      color: white;
      transform: scale(1.1);
      border-color: var(--text-primary);
    }

    /* Hide collapse button when chat panel is collapsed */
    .chat-panel.collapsed .collapse-button {
      display: none;
    }

    .chat-panel-collapsed-ui {
      display: none;
      width: 100%;
      height: 100%;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 0;
      background: var(--bg-tertiary);
    }

    .chat-panel.collapsed .chat-panel-collapsed-ui {
      display: flex;
    }

    .expand-chat-button {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      padding: 16px 10px;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .expand-chat-button:hover {
      background: var(--text-secondary);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Responsive Design - Mobile & Tablet */
    @media (max-width: 768px) {
      .chat-header {
        padding: 20px 24px;
      }

      .chat-header h1 {
        font-size: 22px;
      }

      .model-badge {
        padding: 6px 12px;
        font-size: 12px;
      }

      .thinking-indicator-badge {
        font-size: 10px;
        padding: 5px 10px;
      }

      .files-header {
        padding: 14px 24px;
      }

      .files-content {
        padding: 20px 24px 24px;
      }

      .drop-zone {
        padding: 36px 24px;
      }

      .drop-zone-icon {
        font-size: 40px;
      }

      .drop-zone-text {
        font-size: 15px;
      }

      .drop-zone-hint {
        font-size: 12px;
      }

      .file-card {
        padding: 14px 16px;
        gap: 12px;
      }

      .file-icon {
        font-size: 24px;
      }

      .file-name {
        font-size: 13px;
      }

      .file-meta {
        font-size: 11px;
      }

      .messages-container {
        padding: 24px 20px;
      }

      .message-content {
        padding: 20px;
      }

      .input-container {
        padding: 20px 24px;
      }

      #user-input {
        min-height: 52px;
        padding: 14px 18px;
        font-size: 14px;
      }

      #send-button {
        padding: 14px 28px;
        font-size: 14px;
        min-width: 90px;
      }

      .compare-button {
        max-width: 100%;
        padding: 18px 40px;
        font-size: 16px;
      }

      .empty-state {
        padding: 60px 24px;
      }

      .empty-state h2 {
        font-size: 26px;
      }

      .empty-state p {
        font-size: 15px;
      }
    }

    @media (max-width: 480px) {
      .chat-header {
        padding: 16px 20px;
      }

      .chat-header h1 {
        font-size: 18px;
      }

      .model-badge {
        padding: 5px 10px;
        font-size: 11px;
      }

      .files-header {
        padding: 12px 20px;
      }

      .files-content {
        padding: 16px 20px 20px;
      }

      .messages-container {
        padding: 20px 16px;
      }

      .message-content {
        padding: 16px;
      }

      .input-container {
        padding: 16px 20px;
      }

      #user-input {
        padding: 12px 16px;
        font-size: 14px;
      }

      #send-button {
        padding: 12px 24px;
        font-size: 13px;
        min-width: 80px;
      }

      .compare-button {
        padding: 16px 32px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <header class="chat-header">
      <h1>SPD Plan Comparison Agent</h1>
      <div class="model-badge" onclick="ChatApp.showApiKeyModal()">
        <span class="thinking-indicator-badge">GEMINI 3 PRO</span>
      </div>
    </header>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal-overlay" style="display: none;" onclick="ChatApp.handleModalClick(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <h2>Configure API Key</h2>
        <p>Enter your Gemini API key to use this application. Your key will be stored in your browser session only.</p>

        <label for="api-key-input">Gemini API Key</label>
        <input type="password" id="api-key-input" placeholder="AIza..." onkeypress="if(event.key === 'Enter') ChatApp.saveApiKey()" />
        <div class="api-key-hint">
          Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
        </div>

        <div class="modal-buttons">
          <button class="modal-button secondary" onclick="ChatApp.closeApiKeyModal()">Cancel</button>
          <button class="modal-button primary" onclick="ChatApp.saveApiKey()">Save Key</button>
        </div>
      </div>
    </div>

    <!-- Plan Docs File Upload Section -->
    <section class="files-section" id="files-section">
      <div class="files-header" onclick="ChatApp.toggleFilesPanel()">
        <div class="files-title">
          <span class="files-icon">üìÅ</span>
          <span>Plan Docs</span>
          <span class="files-count" id="files-count">(0 files)</span>
        </div>
        <span class="files-toggle" id="files-toggle">‚ñº</span>
      </div>

      <div class="files-content" id="files-content">
        <div class="drop-zone" id="drop-zone">
          <input type="file" id="file-input" multiple accept=".pdf,.txt,.docx,.doc,.csv,.xlsx,.xls,image/*" hidden>
          <div class="drop-zone-content">
            <div class="drop-zone-icon">üìÑ</div>
            <div class="drop-zone-text">Drop files here or click to browse</div>
            <div class="drop-zone-hint">Supports PDF, DOCX, TXT, CSV, Excel, and images ‚Ä¢ Max 1,000 pages per PDF ‚Ä¢ 20 MB inline limit</div>
          </div>
        </div>

        <div class="files-list" id="files-list">
          <!-- File cards will be dynamically added here -->
        </div>
      </div>
    </section>

    <div class="messages-container" id="messages">
      <div class="empty-state">
        <h2>Ready to compare plan documents</h2>
        <p>Upload your PDF files above and click "Compare Documents" to begin analysis.</p>
      </div>
    </div>

    <!-- Three-Output Tab Interface (shown after comparison) -->
    <div class="output-tabs" id="output-tabs">
      <div class="tabs-header">
        <button class="tab-button active" onclick="ChatApp.switchTab('summary')">
          Summary
        </button>
        <button class="tab-button" onclick="ChatApp.switchTab('comparison')">
          Comparison Spreadsheet
        </button>
        <button class="tab-button" onclick="ChatApp.switchTab('language')">
          Language Comparison
        </button>
        <button class="tab-button coming-soon-tab" disabled title="Additional features coming soon">
          Coming Soon
        </button>
      </div>

      <!-- Tab 1: Summary -->
      <div class="tab-content active" id="tab-summary">
        <div class="output-header">
          <h2 class="output-title">Summary</h2>
          <button class="download-button" onclick="ChatApp.downloadSummary()">
            üìÑ Download Summary.md
          </button>
        </div>
        <div class="summary-content" id="summary-output"></div>
      </div>

      <!-- Tab 2: Comparison Spreadsheet -->
      <div class="tab-content" id="tab-comparison">
        <div class="output-header">
          <h2 class="output-title">Comparison Spreadsheet</h2>
          <button class="download-button" onclick="ChatApp.downloadComparisonSpreadsheet()">
            üìä Download Comparison.xlsx
          </button>
        </div>
        <div id="comparison-output"></div>
      </div>

      <!-- Tab 3: Language Comparison -->
      <div class="tab-content" id="tab-language">
        <div class="output-header">
          <h2 class="output-title">Language Comparison</h2>
          <button class="download-button" onclick="ChatApp.downloadLanguageComparison()">
            üìã Download Language.xlsx
          </button>
        </div>
        <div id="language-output"></div>
      </div>
    </div>

    <!-- Split View for Chat (shown when chat tab is active) -->
    <div class="split-view" id="split-view">
      <!-- Left panel: Results -->
      <div class="results-panel">
        <div class="mini-tabs">
          <button class="mini-tab" data-result="summary" onclick="ChatApp.switchMiniResultTab('summary')">Summary</button>
          <button class="mini-tab active" data-result="comparison" onclick="ChatApp.switchMiniResultTab('comparison')">Comparison</button>
          <button class="mini-tab" data-result="language" onclick="ChatApp.switchMiniResultTab('language')">Language</button>
        </div>
        <div class="mini-output-content" id="mini-output-content"></div>
      </div>

      <!-- Resize Handle -->
      <div class="resize-handle" id="resize-handle">
        <div class="resize-handle-line"></div>
      </div>

      <!-- Right panel: Chat -->
      <div class="chat-panel" id="chat-panel">
        <!-- Collapse button (shown when expanded) -->
        <button class="collapse-button" id="collapse-chat-button" title="Collapse chat panel">
          ‚óÄ
        </button>

        <div class="chat-messages-container" id="chat-messages"></div>
        <div class="chat-input-area">
          <textarea id="chat-input" placeholder="Ask about the analysis..." rows="1"></textarea>
          <button id="chat-send-button">Send</button>
        </div>

        <!-- Collapsed state UI -->
        <div class="chat-panel-collapsed-ui">
          <button class="expand-chat-button" onclick="ChatApp.toggleChatPanel()">
            Chat
          </button>
        </div>
      </div>
    </div>

    <div class="input-container">
      <form class="input-form" id="chat-form">
        <textarea
          id="user-input"
          placeholder="Ask anything..."
          rows="1"
          autofocus
        ></textarea>
        <button type="submit" id="send-button">Send</button>
      </form>
    </div>
  </div>

  <!-- Load config before app script -->
  <script src="config.js"></script>

  <script>
    // Configure marked for markdown rendering
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
      highlight: function(code, lang) {
        if (Prism.languages[lang]) {
          return Prism.highlight(code, Prism.languages[lang], lang);
        }
        return code;
      }
    });

    // Three Prompt Templates for Sequential API Calls
    const PROMPT_TEMPLATES = {
      phase1: () => {
        return `Comprehensively read all of the attached documents. You must return an organized overview of which documents are which, how they relate to one another, and the general domain, content, and structure of each.

Return ONLY the organized overview with no preamble or footnotes. Be as concise as possible without oversimplifying. Maximum 500 words response.`;
      },

      phase2: (summaryResponse) => {
        return `Comprehensively read and analyze all of the attached documents. Here is a summary of the documents' content and structure:

<summary>
${summaryResponse}
</summary>

I want you to return a detailed and comprehensive table comparing elements across all plans. Columns should represent identified plans, and rows should represent identified procedural elements within the plans. The purpose of this table is to compare procedural elements across all plan documents at a glance.

Return ONLY the comparison table with no preamble, introduction, or footnotes. Do not oversimplify. Do not condense. Complete this task as comprehensively and completely as possible.`;
      },

      phase3: (summaryResponse, comparisonResponse) => {
        return `Comprehensively read and analyze all of the attached documents. Here is a summary of the documents' content and structure:

<summary>
${summaryResponse}
</summary>

Here is a table comparing the various procedural elements by plan:

<comparison>
${comparisonResponse}
</comparison>

I want you to create a more detailed version of this table which fully quotes and cites the language from each and every document which represents the procedural elements being compared. The purpose of this is to facilitate quick analysis of the plan document changes and amendments over time while citing the specific language applicable in as detailed a manner as possible.

Your citations must be in parentheses behind each and every statement cited and must be structured as follows: (filename, page_number, paragraph_number).

Return ONLY the detailed comparison table with no preamble, introduction, or footnotes. Do not oversimplify. Do not condense. Complete this task as comprehensively and completely as possible.`;
      }
    };

    // Chat Application
    const ChatApp = {
      state: {
        messages: [],
        isStreaming: false,
        currentThinking: '',
        currentResponse: '',
        currentBlockType: null,
        abortController: null,
        uploadedFiles: [],
        filesPanelExpanded: true,
        // Three-phase response tracking
        currentPhase: 0, // 0 = not started, 1-3 = active phase
        summaryResponse: null, // Phase 1 result
        comparisonResponse: null, // Phase 2 result
        languageResponse: null, // Phase 3 result
        activeTab: 'summary', // Current active tab
        isComparisonRequest: false, // Track if this is a comparison vs. regular chat
        // Chat-specific state
        chatMessages: [], // [{role, content, timestamp}]
        isChatStreaming: false, // Separate from main isStreaming
        currentChatResponse: '', // Accumulator for chat streaming
        chatPanelResultTab: 'comparison', // Which result to show in left panel
        // Split view state
        splitPanelWidth: 40, // Percentage for results panel (default 40%)
        isResizing: false, // Track if user is dragging resize handle
        chatPanelCollapsed: true, // Track if chat panel is collapsed (default: collapsed)
        // API key management
        sessionApiKey: null // API key from modal (session only)
      },

      init() {
        this.renderInputArea();
        this.initFileUpload();
        this.loadSessionApiKey();
        this.loadSplitViewPreferences();
      },

      loadSplitViewPreferences() {
        // Load saved split panel width
        const savedWidth = localStorage.getItem('splitPanelWidth');
        if (savedWidth) {
          this.state.splitPanelWidth = parseFloat(savedWidth);
        }

        // Load saved collapse state
        const savedCollapsed = localStorage.getItem('chatPanelCollapsed');
        if (savedCollapsed === 'true') {
          this.state.chatPanelCollapsed = true;
        }
      },

      // API Key Modal Functions
      showApiKeyModal() {
        const modal = document.getElementById('api-key-modal');
        const input = document.getElementById('api-key-input');

        // Pre-fill with session key if exists
        if (this.state.sessionApiKey) {
          input.value = this.state.sessionApiKey;
        }

        modal.style.display = 'flex';
        setTimeout(() => input.focus(), 100);
      },

      closeApiKeyModal() {
        document.getElementById('api-key-modal').style.display = 'none';
      },

      handleModalClick(event) {
        // Close modal when clicking on overlay (outside the modal box)
        if (event.target.id === 'api-key-modal') {
          this.closeApiKeyModal();
        }
      },

      saveApiKey() {
        const input = document.getElementById('api-key-input');
        const apiKey = input.value.trim();

        if (!apiKey) {
          alert('Please enter an API key');
          return;
        }

        if (!apiKey.startsWith('AIza')) {
          alert('Invalid API key format. Gemini API keys start with "AIza"');
          return;
        }

        // Store in session storage
        sessionStorage.setItem('gemini_api_key', apiKey);
        this.state.sessionApiKey = apiKey;

        console.log('‚úÖ API Key saved to session');
        this.closeApiKeyModal();
      },

      loadSessionApiKey() {
        const savedKey = sessionStorage.getItem('gemini_api_key');
        if (savedKey) {
          this.state.sessionApiKey = savedKey;
          console.log('‚úÖ API Key loaded from session');
        }
      },

      getApiKey() {
        // Use session key if available, otherwise fall back to config.js
        return this.state.sessionApiKey || CONFIG.GEMINI_API_KEY;
      },

      isInitialState() {
        return this.state.messages.length === 0;
      },

      renderInputArea() {
        const inputContainer = document.querySelector('.input-container');

        if (this.isInitialState()) {
          const hasFiles = this.state.uploadedFiles.filter(f => f.status === 'uploaded').length > 0;
          const isUploading = this.state.uploadedFiles.some(f => f.status === 'uploading');

          let helperText, helperClass, buttonDisabled;

          if (isUploading) {
            helperText = 'Waiting for files to finish uploading...';
            helperClass = 'warning';
            buttonDisabled = true;
          } else if (!hasFiles) {
            helperText = 'Upload plan documents above to begin comparison';
            helperClass = '';
            buttonDisabled = true;
          } else {
            helperText = 'Click to compare uploaded plan documents';
            helperClass = '';
            buttonDisabled = false;
          }

          inputContainer.innerHTML = `
            <div class="initial-prompt">
              <button
                type="button"
                id="compare-button"
                class="compare-button"
                ${buttonDisabled ? 'disabled' : ''}
              >
                Compare Documents
              </button>
              <p class="helper-text ${helperClass}" id="compare-helper">
                ${helperText}
              </p>
            </div>
          `;

          this.attachCompareButtonHandler();
        } else {
          // Hide input area after comparison starts - workflow uses Compare Documents button only
          inputContainer.style.display = 'none';
        }
      },

      attachCompareButtonHandler() {
        const compareButton = document.getElementById('compare-button');
        if (compareButton) {
          compareButton.addEventListener('click', () => {
            if (!this.state.isStreaming && !compareButton.disabled) {
              // Auto-collapse Plan Docs section
              if (this.state.filesPanelExpanded) {
                this.toggleFilesPanel();
              }
              // Mark this as a comparison request (not regular chat)
              this.state.isComparisonRequest = true;
              this.sendMessage('Compare the attached plan documents.');
            }
          });
        }
      },

      setupEventListeners() {
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const message = input.value.trim();
          if (message && !this.state.isStreaming) {
            this.sendMessage(message);
            input.value = '';
            input.style.height = 'auto';
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
          }
        });

        input.addEventListener('input', () => {
          input.style.height = 'auto';
          input.style.height = Math.min(input.scrollHeight, 200) + 'px';
        });
      },

      autoResizeTextarea() {
        const input = document.getElementById('user-input');
        input.style.height = 'auto';
        input.style.height = input.scrollHeight + 'px';
      },

      addMessage(role, content, thinking = '') {
        this.state.messages.push({
          role,
          content,
          thinking
        });
        this.render();
      },

      async sendMessage(userMessage) {
        // Check if any files are still uploading
        const uploadingFiles = this.state.uploadedFiles.filter(f => f.status === 'uploading');
        if (uploadingFiles.length > 0) {
          alert('Please wait for all files to finish uploading before sending a message.');
          return;
        }

        // Track if this was the initial state
        const wasInitialState = this.isInitialState();

        // Clear empty state
        const messagesContainer = document.getElementById('messages');
        const emptyState = messagesContainer.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        // Add user message
        this.addMessage('user', userMessage);

        // Transition UI if this was the first message
        if (wasInitialState) {
          this.renderInputArea();
        }

        // For comparison requests, run three-phase analysis
        if (this.state.isComparisonRequest) {
          await this.runThreePhaseComparison();
          return;
        }

        // For regular chat (not implemented in this version)
        alert('Regular chat mode is not implemented. Please use the Compare Documents button.');
      },

      async runThreePhaseComparison() {
        this.state.isStreaming = true;
        this.updateSendButton(true);

        // Show loading indicator
        this.createStreamingMessage();

        try {
          // PHASE 1: Document Summary
          this.state.currentPhase = 1;
          this.updateComparisonPhase(1, 'Reading and identifying document structure...');
          this.state.currentResponse = '';
          this.state.currentThinking = '';

          const prompt1 = PROMPT_TEMPLATES.phase1();
          this.state.summaryResponse = await this.streamResponse(prompt1, true); // true = upload files

          // Populate Summary tab
          this.renderSummaryTab();
          this.activateTab('summary');

          // PHASE 2: Comparison Table
          this.state.currentPhase = 2;
          this.updateComparisonPhase(2, 'Building comparison table across plans...');
          this.state.currentResponse = '';
          this.state.currentThinking = '';

          const prompt2 = PROMPT_TEMPLATES.phase2(this.state.summaryResponse);
          this.state.comparisonResponse = await this.streamResponse(prompt2, true); // true = upload files fresh

          // Populate Comparison tab
          this.renderComparisonTab();

          // PHASE 3: Language Comparison
          this.state.currentPhase = 3;
          this.updateComparisonPhase(3, 'Extracting detailed language with citations...');
          this.state.currentResponse = '';
          this.state.currentThinking = '';

          const prompt3 = PROMPT_TEMPLATES.phase3(this.state.summaryResponse, this.state.comparisonResponse);
          this.state.languageResponse = await this.streamResponse(prompt3, true); // true = upload files fresh

          // Populate Language tab
          this.renderLanguageTab();

          // Complete - remove loading indicator and show output tabs
          this.finalizeThreePhaseComparison();

        } catch (error) {
          this.handleError(error);
        } finally {
          this.state.isStreaming = false;
          this.state.currentPhase = 0;
          this.updateSendButton(false);
        }
      },

      createStreamingMessage() {
        const messagesContainer = document.getElementById('messages');

        // For comparison requests, show smart loading indicator
        if (this.state.isComparisonRequest) {
          const loadingDiv = document.createElement('div');
          loadingDiv.id = 'comparison-loading';
          loadingDiv.className = 'comparison-loading-container';
          loadingDiv.innerHTML = `
            <div class="comparison-loading-spinner"></div>
            <div class="comparison-loading-text">Analyzing Documents</div>
            <div class="comparison-loading-phase" id="comparison-phase">
              Reading and identifying document structure...
            </div>
            <div class="comparison-progress-dots">
              <div class="progress-dot active" id="progress-dot-1"></div>
              <div class="progress-dot" id="progress-dot-2"></div>
              <div class="progress-dot" id="progress-dot-3"></div>
            </div>
          `;
          messagesContainer.appendChild(loadingDiv);
          this.scrollToBottom();
          return;
        }

        // Regular chat: show normal streaming message
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant streaming';
        messageDiv.id = 'streaming-message';
        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="message-role">Assistant</span>
          </div>
          <div class="message-content">
            <div id="streaming-thinking" style="display: none;"></div>
            <div id="streaming-response"></div>
            <div class="streaming-indicator">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        `;
        messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
      },

      async streamResponse(userPrompt, uploadFiles = false) {
        this.state.abortController = new AbortController();

        // Build message parts
        const parts = [];

        // Add uploaded files if requested (fresh upload for each phase)
        if (uploadFiles) {
          const uploadedFiles = this.state.uploadedFiles.filter(f => f.status === 'uploaded');
          uploadedFiles.forEach(file => {
            parts.push({
              inline_data: {
                mime_type: file.mimeType,
                data: file.base64Data
              }
            });
          });
          console.log(`üì§ API Request: Uploading ${uploadedFiles.length} PDF file(s)`);
        }

        // Add user prompt text
        parts.push({ text: userPrompt });

        const contents = [{ role: 'user', parts }];

        const model = CONFIG.MODEL || 'gemini-3-pro-preview';

        // Build request body with vanilla system instruction
        const requestBody = {
          systemInstruction: {
            parts: [{ text: 'You are a helpful assistant.' }]
          },
          contents: contents,
          generationConfig: {
            maxOutputTokens: CONFIG.MAX_OUTPUT_TOKENS || 32768,
            temperature: 1.0,
            thinkingConfig: {
              thinkingLevel: CONFIG.THINKING_LEVEL || 'high'
            }
          }
        };

        console.log(`üì§ API Request: Phase ${this.state.currentPhase}/3 to ${model}`);
        console.log(`üìù Prompt (first 200 chars): ${userPrompt.substring(0, 200)}...`);

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?alt=sse`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': this.getApiKey()
            },
            body: JSON.stringify(requestBody),
            signal: this.state.abortController.signal
          }
        );

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå API Error (${response.status}):`, errorText);
          throw new Error(`API request failed (${response.status}): ${errorText}`);
        }

        console.log(`‚úÖ API Response: Streaming started`);

        const reader = response.body
          .pipeThrough(new TextDecoderStream())
          .getReader();

        let buffer = '';
        let chunkCount = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += value;
          const events = buffer.split(/\r?\n\r?\n/);
          buffer = events.pop() || '';

          for (const event of events) {
            if (!event.trim()) continue;

            const lines = event.split(/\r?\n/);
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const jsonData = line.slice(6);
                  const chunk = JSON.parse(jsonData);
                  this.handleStreamChunk(chunk);
                  chunkCount++;
                } catch (e) {
                  console.error('Parse error:', e, line);
                }
              }
            }
          }
        }

        const responseLength = this.state.currentResponse.length;
        console.log(`‚úÖ API Response Complete: Phase ${this.state.currentPhase}/3 - ${chunkCount} chunks, ${responseLength} chars`);

        // Return the accumulated response
        return this.state.currentResponse;
      },

      handleStreamChunk(chunk) {
        // Extract parts from the chunk
        const candidate = chunk.candidates?.[0];
        if (!candidate || !candidate.content || !candidate.content.parts) return;

        for (const part of candidate.content.parts) {
          if (part.thought) {
            // This is a thinking summary
            // Thinking text might be in part.thought itself (if string) or part.text when part.thought is true
            const thinkingText = typeof part.thought === 'string' ? part.thought : (part.text || '');
            this.state.currentThinking += thinkingText;
            this.updateStreamingThinking();
          } else if (part.text) {
            // This is the main response
            this.state.currentResponse += part.text;
            this.updateStreamingResponse();
          }
        }

        // Check if thinking is done (finishReason indicates completion)
        if (candidate.finishReason && this.state.currentThinking && !this.state.thinkingCollapsed) {
          this.collapseStreamingThinking();
          this.state.thinkingCollapsed = true;
        }
      },

      updateStreamingThinking() {
        // Skip DOM updates for comparison requests (no streaming message to update)
        if (this.state.isComparisonRequest) return;

        const thinkingDiv = document.getElementById('streaming-thinking');
        if (thinkingDiv && this.state.currentThinking) {
          thinkingDiv.style.display = 'block';
          const thinkingId = 'thinking-streaming';
          thinkingDiv.innerHTML = `
            <div class="thinking-block">
              <div class="thinking-header" onclick="ChatApp.toggleThinking('${thinkingId}')">
                <span>Thinking</span>
                <span class="thinking-toggle" id="${thinkingId}-toggle">Hide</span>
              </div>
              <div class="thinking-content" id="${thinkingId}">
                ${this.escapeHtml(this.state.currentThinking)}
              </div>
            </div>
          `;
        }
      },

      collapseStreamingThinking() {
        const thinkingContent = document.getElementById('thinking-streaming');
        const thinkingToggle = document.getElementById('thinking-streaming-toggle');
        if (thinkingContent && thinkingToggle) {
          thinkingContent.classList.add('collapsed');
          thinkingToggle.textContent = 'Show';
        }
      },

      updateStreamingResponse() {
        const responseDiv = document.getElementById('streaming-response');
        if (responseDiv) {
          responseDiv.innerHTML = marked.parse(this.state.currentResponse);
          this.scrollToBottom();
        }
      },

      updateComparisonPhase(phase, phaseText) {
        const phaseDiv = document.getElementById('comparison-phase');
        if (phaseDiv) {
          phaseDiv.textContent = `Phase ${phase}/3: ${phaseText}`;
        }

        // Update progress dots
        for (let i = 1; i <= 3; i++) {
          const dot = document.getElementById(`progress-dot-${i}`);
          if (dot) {
            if (i <= phase) {
              dot.classList.add('active');
            } else {
              dot.classList.remove('active');
            }
          }
        }
      },

      finalizeThreePhaseComparison() {
        // Remove loading indicator
        const comparisonLoading = document.getElementById('comparison-loading');
        if (comparisonLoading) {
          comparisonLoading.remove();
        }

        // Hide messages container, show output tabs AND split view (chat sidebar)
        document.getElementById('messages').style.display = 'none';
        document.getElementById('output-tabs').classList.add('active');
        document.getElementById('split-view').classList.add('active');

        // Set chat panel to collapsed state by default
        const chatPanel = document.getElementById('chat-panel');
        const collapseButton = document.getElementById('collapse-chat-button');
        if (chatPanel && this.state.chatPanelCollapsed) {
          chatPanel.classList.add('collapsed');
          if (collapseButton) {
            collapseButton.innerHTML = '‚ñ∂';
            collapseButton.title = 'Expand chat panel';
          }
        }

        // Initialize resize handle (only once)
        if (!this._resizeHandleInitialized) {
          this.initResizeHandle();
          this._resizeHandleInitialized = true;
        }

        // Initialize chat event listeners
        this.initChatEventListeners();

        // Render initial result panel content (for when chat expands)
        this.renderMiniResultPanel(this.state.chatPanelResultTab);

        // Reset state
        this.state.isComparisonRequest = false;
      },

      renderSummaryTab() {
        const output = document.getElementById('summary-output');
        // Render the summary response as markdown
        output.innerHTML = marked.parse(this.state.summaryResponse || '');
      },

      renderComparisonTab() {
        const output = document.getElementById('comparison-output');
        // Parse the comparison response and render as HTML table
        // The response should be a markdown table, so we can render it directly
        output.innerHTML = marked.parse(this.state.comparisonResponse || '');
      },

      renderLanguageTab() {
        const output = document.getElementById('language-output');
        // Parse the language comparison response and render as HTML table
        // The response should be a markdown table, so we can render it directly
        output.innerHTML = marked.parse(this.state.languageResponse || '');
      },

      activateTab(tabName) {
        // Update active tab in state
        this.state.activeTab = tabName;

        // Update tab button classes
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        const activeButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
        if (activeButton) {
          activeButton.classList.add('active');
        }

        // Show/hide tab content
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        const activeTab = document.getElementById(`tab-${tabName}`);
        if (activeTab) {
          activeTab.classList.add('active');
        }
      },

      finalizeStreamingMessage() {
        // Remove loading indicator for comparison requests
        const comparisonLoading = document.getElementById('comparison-loading');
        if (comparisonLoading) {
          comparisonLoading.remove();
        }

        // Remove regular streaming message for chat
        const streamingMessage = document.getElementById('streaming-message');
        if (streamingMessage) {
          streamingMessage.remove();
        }

        // Try to parse as JSON and render outputs
        try {
          this.parseAndRenderOutputs(this.state.currentResponse);
        } catch (error) {
          // If JSON parsing fails, fall back to regular message display
          console.error('Not JSON response, falling back to message display:', error);
          this.addMessage('model', this.state.currentResponse, this.state.currentThinking);
          this.render();
        }

        // Reset streaming state
        this.state.currentThinking = '';
        this.state.currentResponse = '';
        this.state.thinkingCollapsed = false;
        this.state.isComparisonRequest = false; // Reset comparison flag
      },

      toggleThinking(id) {
        const content = document.getElementById(id);
        const toggle = document.getElementById(id + '-toggle');
        if (content && toggle) {
          content.classList.toggle('collapsed');
          toggle.textContent = content.classList.contains('collapsed') ? 'Show' : 'Hide';
        }
      },

      render() {
        const messagesContainer = document.getElementById('messages');
        const streamingMessage = document.getElementById('streaming-message');

        // Don't re-render if streaming
        if (streamingMessage) return;

        // Clear and rebuild (except streaming message)
        const messages = this.state.messages.map((msg, index) => {
          const thinking = msg.thinking || '';
          const thinkingId = `thinking-${index}`;

          if (msg.role === 'user') {
            return `
              <div class="message user">
                <div class="message-header">
                  <span class="message-role">You</span>
                </div>
                <div class="message-content">
                  ${this.escapeHtml(msg.content)}
                </div>
              </div>
            `;
          } else {
            return `
              <div class="message assistant">
                <div class="message-header">
                  <span class="message-role">Assistant</span>
                </div>
                <div class="message-content">
                  ${thinking ? `
                    <div class="thinking-block">
                      <div class="thinking-header" onclick="ChatApp.toggleThinking('${thinkingId}')">
                        <span>Thinking</span>
                        <span class="thinking-toggle" id="${thinkingId}-toggle">Show</span>
                      </div>
                      <div class="thinking-content collapsed" id="${thinkingId}">
                        ${this.escapeHtml(thinking)}
                      </div>
                    </div>
                  ` : ''}
                  <div class="response-text">
                    ${marked.parse(msg.content)}
                  </div>
                </div>
              </div>
            `;
          }
        }).join('');

        messagesContainer.innerHTML = messages;
        this.scrollToBottom();
      },

      handleError(error) {
        console.error('Chat error:', error);

        const streamingMessage = document.getElementById('streaming-message');
        if (streamingMessage) {
          streamingMessage.remove();
        }

        // If this was the first message and it failed, revert to initial state
        if (this.state.messages.length === 1 && this.state.messages[0].role === 'user') {
          this.state.messages = []; // Clear the failed attempt
          this.renderInputArea(); // Show Compare button again
        }

        const messagesContainer = document.getElementById('messages');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message assistant';
        errorDiv.innerHTML = `
          <div class="message-header">
            <span class="message-role">Error</span>
          </div>
          <div class="message-content">
            <div class="error-message">
              <strong>Error:</strong> ${this.escapeHtml(error.message)}
              ${this.state.messages.length === 0 ? '<br><small>Try clicking "Compare Documents" again.</small>' : ''}
            </div>
          </div>
        `;
        messagesContainer.appendChild(errorDiv);
        this.scrollToBottom();
      },

      updateSendButton(disabled) {
        const button = document.getElementById('send-button');
        if (button) {
          button.disabled = disabled;
          button.textContent = disabled ? 'Sending...' : 'Send';
        }
      },

      scrollToBottom() {
        const container = document.getElementById('messages');
        container.scrollTop = container.scrollHeight;
      },

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      // File Upload Functions
      initFileUpload() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        // Click to browse
        dropZone.addEventListener('click', () => {
          fileInput.click();
        });

        // File selection
        fileInput.addEventListener('change', (e) => {
          this.handleFileSelect(e.target.files);
          fileInput.value = ''; // Reset input
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => this.handleDragOver(e));
        dropZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        dropZone.addEventListener('drop', (e) => this.handleDrop(e));
      },

      toggleFilesPanel() {
        this.state.filesPanelExpanded = !this.state.filesPanelExpanded;
        const content = document.getElementById('files-content');
        const toggle = document.getElementById('files-toggle');

        if (this.state.filesPanelExpanded) {
          content.classList.remove('collapsed');
          toggle.classList.remove('collapsed');
          toggle.textContent = '‚ñº';
        } else {
          content.classList.add('collapsed');
          toggle.classList.add('collapsed');
          toggle.textContent = '‚ñ∂';
        }
      },

      handleFileSelect(files) {
        if (files.length === 0) return;

        Array.from(files).forEach(file => {
          this.uploadFile(file);
        });
      },

      handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        const dropZone = document.getElementById('drop-zone');
        dropZone.classList.add('dragging');
      },

      handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        const dropZone = document.getElementById('drop-zone');
        if (e.target === dropZone) {
          dropZone.classList.remove('dragging');
        }
      },

      handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        const dropZone = document.getElementById('drop-zone');
        dropZone.classList.remove('dragging');

        const files = e.dataTransfer.files;
        this.handleFileSelect(files);
      },

      async uploadFile(file) {
        // Validate file size (20 MB limit for inline base64)
        const maxSize = 20 * 1024 * 1024; // 20 MB in bytes
        if (file.size > maxSize) {
          alert(`File "${file.name}" is too large. Maximum size is 20 MB per file for inline upload.`);
          return;
        }

        // Create temporary file card
        const tempId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const fileObj = {
          id: tempId,
          filename: file.name,
          size: file.size,
          mimeType: file.type || 'application/pdf',
          status: 'uploading',
          uploadedAt: new Date().toISOString(),
          base64Data: null
        };

        this.state.uploadedFiles.push(fileObj);
        this.renderFilesList();
        this.updateFilesCount();

        try {
          // Read file as base64
          const base64Data = await this.readFileAsBase64(file);

          // Update file object with base64 data
          const fileIndex = this.state.uploadedFiles.findIndex(f => f.id === tempId);
          if (fileIndex !== -1) {
            this.state.uploadedFiles[fileIndex].base64Data = base64Data;
            this.state.uploadedFiles[fileIndex].status = 'uploaded';
          }

          this.renderFilesList();
          this.renderInputArea(); // Update button state

        } catch (error) {
          console.error('Upload error:', error);

          // Mark file as error
          const fileIndex = this.state.uploadedFiles.findIndex(f => f.id === tempId);
          if (fileIndex !== -1) {
            this.state.uploadedFiles[fileIndex].status = 'error';
            this.state.uploadedFiles[fileIndex].error = error.message;
          }

          this.renderFilesList();
          this.renderInputArea(); // Update button state
          alert(`Failed to load "${file.name}": ${error.message}`);
        }
      },

      readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = () => {
            // Remove the data URL prefix (e.g., "data:application/pdf;base64,")
            const base64String = reader.result.split(',')[1];
            resolve(base64String);
          };

          reader.onerror = () => {
            reject(new Error('Failed to read file'));
          };

          reader.readAsDataURL(file);
        });
      },

      removeFile(fileId) {
        // Remove from state (base64 data is stored locally, no API cleanup needed)
        this.state.uploadedFiles = this.state.uploadedFiles.filter(f => f.id !== fileId);
        this.renderFilesList();
        this.updateFilesCount();
        this.renderInputArea(); // Update button state
      },

      renderFilesList() {
        const filesList = document.getElementById('files-list');

        if (this.state.uploadedFiles.length === 0) {
          filesList.innerHTML = '';
          return;
        }

        filesList.innerHTML = this.state.uploadedFiles.map(file => {
          const icon = this.getFileIcon(file.mimeType);
          const statusClass = file.status;
          const statusText = file.status === 'uploading' ? 'Uploading...' :
                            file.status === 'uploaded' ? '‚úì Uploaded' :
                            '‚úó Error';

          return `
            <div class="file-card ${statusClass}">
              <div class="file-icon">${icon}</div>
              <div class="file-info">
                <div class="file-name">${this.escapeHtml(file.filename)}</div>
                <div class="file-meta">
                  <span class="file-size">${this.formatFileSize(file.size)}</span>
                  <span class="file-status ${statusClass}">${statusText}</span>
                </div>
              </div>
              <button class="file-remove" onclick="ChatApp.removeFile('${file.id}')" title="Remove file">
                √ó
              </button>
            </div>
          `;
        }).join('');
      },

      updateFilesCount() {
        const count = this.state.uploadedFiles.length;
        const filesCount = document.getElementById('files-count');
        filesCount.textContent = `(${count} ${count === 1 ? 'file' : 'files'})`;
      },

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 10) / 10 + ' ' + sizes[i];
      },

      getFileIcon(mimeType) {
        if (!mimeType) return 'üìÑ';

        if (mimeType.includes('pdf')) return 'üìï';
        if (mimeType.includes('image')) return 'üñºÔ∏è';
        if (mimeType.includes('word') || mimeType.includes('document')) return 'üìò';
        if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || mimeType.includes('csv')) return 'üìä';
        if (mimeType.includes('text')) return 'üìù';

        return 'üìÑ';
      },

      // ===== NEW: Three-Output Tab System =====

      switchTab(tabName) {
        // Update active tab state
        this.state.activeTab = tabName;

        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update tab content (summary/comparison/language)
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');

        // Also update mini result panel to match (for chat sidebar)
        this.renderMiniResultPanel(tabName);
      },

      // ===== Chat Feature Methods =====

      switchMiniResultTab(resultType) {
        // Update state
        this.state.chatPanelResultTab = resultType;

        // Update mini-tab styling
        document.querySelectorAll('.mini-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.result === resultType);
        });

        // Render selected result in left panel
        this.renderMiniResultPanel(resultType);
      },

      renderMiniResultPanel(resultType) {
        const content = document.getElementById('mini-output-content');
        let markdown = '';

        switch(resultType) {
          case 'summary':
            markdown = this.state.summaryResponse;
            break;
          case 'comparison':
            markdown = this.state.comparisonResponse;
            break;
          case 'language':
            markdown = this.state.languageResponse;
            break;
        }

        content.innerHTML = marked.parse(markdown || '');
      },

      initResizeHandle() {
        const handle = document.getElementById('resize-handle');
        const splitView = document.getElementById('split-view');
        const collapseButton = document.getElementById('collapse-chat-button');

        if (!handle || !splitView) return;

        // Handle drag to resize
        handle.addEventListener('mousedown', (e) => {
          // Don't start resize if clicking the collapse button
          if (e.target === collapseButton || e.target.closest('.collapse-button')) {
            return;
          }

          this.state.isResizing = true;
          document.body.classList.add('resizing');
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!this.state.isResizing) return;

          const splitViewRect = splitView.getBoundingClientRect();
          const offsetX = e.clientX - splitViewRect.left;
          const percentage = (offsetX / splitViewRect.width) * 100;

          // Constrain between 20% and 70%
          const constrainedPercentage = Math.min(Math.max(percentage, 20), 70);
          this.state.splitPanelWidth = constrainedPercentage;

          this.updateSplitPanelSizes();
        });

        document.addEventListener('mouseup', () => {
          if (this.state.isResizing) {
            this.state.isResizing = false;
            document.body.classList.remove('resizing');
            // Persist to localStorage
            localStorage.setItem('splitPanelWidth', this.state.splitPanelWidth);
          }
        });

        // Handle collapse button
        if (collapseButton) {
          collapseButton.addEventListener('click', () => this.toggleChatPanel());
        }
      },

      updateSplitPanelSizes() {
        const resultsPanel = document.querySelector('.results-panel');
        const chatPanel = document.querySelector('.chat-panel');

        if (resultsPanel && chatPanel && !this.state.chatPanelCollapsed) {
          resultsPanel.style.flex = `0 0 ${this.state.splitPanelWidth}%`;
          chatPanel.style.flex = '1';
        }
      },

      toggleChatPanel() {
        this.state.chatPanelCollapsed = !this.state.chatPanelCollapsed;
        const splitView = document.getElementById('split-view');
        const chatPanel = document.getElementById('chat-panel');
        const collapseButton = document.getElementById('collapse-chat-button');
        const outputTabs = document.getElementById('output-tabs');

        if (this.state.chatPanelCollapsed) {
          // Collapse to 48px sidebar
          splitView.classList.remove('expanded');
          chatPanel.classList.add('collapsed');
          outputTabs.classList.remove('chat-expanded');
          if (collapseButton) {
            collapseButton.innerHTML = '‚ñ∂';
            collapseButton.title = 'Expand chat panel';
          }
        } else {
          // Expand to 400px chat panel
          splitView.classList.add('expanded');
          chatPanel.classList.remove('collapsed');
          outputTabs.classList.add('chat-expanded');
          if (collapseButton) {
            collapseButton.innerHTML = '‚óÄ';
            collapseButton.title = 'Collapse chat panel';
          }
        }

        // Persist to localStorage
        localStorage.setItem('chatPanelCollapsed', this.state.chatPanelCollapsed);
      },

      initChatEventListeners() {
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');

        // Remove existing listeners to avoid duplicates
        const newChatInput = chatInput.cloneNode(true);
        const newChatSendButton = chatSendButton.cloneNode(true);
        chatInput.parentNode.replaceChild(newChatInput, chatInput);
        chatSendButton.parentNode.replaceChild(newChatSendButton, chatSendButton);

        // Add new listeners
        newChatSendButton.addEventListener('click', () => {
          const message = newChatInput.value.trim();
          if (message && !this.state.isChatStreaming) {
            this.sendChatMessage(message);
            newChatInput.value = '';
            newChatInput.style.height = 'auto';
          }
        });

        newChatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            newChatSendButton.click();
          }
        });

        newChatInput.addEventListener('input', () => {
          newChatInput.style.height = 'auto';
          newChatInput.style.height = Math.min(newChatInput.scrollHeight, 150) + 'px';
        });
      },

      async sendChatMessage(userQuestion) {
        // Add user message to chat history
        this.state.chatMessages.push({
          role: 'user',
          content: userQuestion,
          timestamp: new Date().toISOString()
        });

        this.renderChatMessages();

        // Build context-enriched prompt
        const contextPrompt = this.buildChatContextPrompt(userQuestion);

        // Stream response with PDFs re-uploaded
        this.state.isChatStreaming = true;
        this.state.currentChatResponse = '';

        // Show streaming indicator
        this.showChatStreamingIndicator();

        const chatSendButton = document.getElementById('chat-send-button');
        if (chatSendButton) {
          chatSendButton.disabled = true;
          chatSendButton.textContent = 'Sending...';
        }

        try {
          const response = await this.streamChatResponse(contextPrompt, true);

          // Add assistant response to history
          this.state.chatMessages.push({
            role: 'assistant',
            content: response,
            timestamp: new Date().toISOString()
          });

          this.renderChatMessages();
        } catch (error) {
          console.error('Chat error:', error);
          this.state.chatMessages.push({
            role: 'assistant',
            content: `Error: ${error.message}`,
            timestamp: new Date().toISOString()
          });
          this.renderChatMessages();
        } finally {
          this.state.isChatStreaming = false;
          this.state.currentChatResponse = '';

          if (chatSendButton) {
            chatSendButton.disabled = false;
            chatSendButton.textContent = 'Send';
          }
        }
      },

      buildChatContextPrompt(userQuestion) {
        return `You are analyzing pension plan documents. Here is the completed analysis:

<document_summary>
${this.state.summaryResponse}
</document_summary>

<comparison_table>
${this.state.comparisonResponse}
</comparison_table>

<detailed_language_comparison>
${this.state.languageResponse}
</detailed_language_comparison>

When referencing the comparison table, cite specific rows or elements (e.g., "See the comparison for 'Claims Procedures'" or "According to row X in the table").

User Question: ${userQuestion}`;
      },

      async streamChatResponse(prompt, uploadFiles) {
        this.state.abortController = new AbortController();

        // Build message parts
        const parts = [];

        // Re-upload PDFs
        if (uploadFiles) {
          const uploadedFiles = this.state.uploadedFiles.filter(f => f.status === 'uploaded');
          uploadedFiles.forEach(file => {
            parts.push({
              inline_data: {
                mime_type: file.mimeType,
                data: file.base64Data
              }
            });
          });
          console.log(`üì§ Chat API Request: Uploading ${uploadedFiles.length} PDF file(s)`);
        }

        parts.push({ text: prompt });

        const contents = [{ role: 'user', parts }];

        const model = CONFIG.MODEL || 'gemini-3-pro-preview';

        const requestBody = {
          systemInstruction: {
            parts: [{ text: 'You are a helpful assistant.' }]
          },
          contents: contents,
          generationConfig: {
            maxOutputTokens: CONFIG.MAX_OUTPUT_TOKENS || 32768,
            temperature: 1.0,
            thinkingConfig: {
              thinkingLevel: CONFIG.THINKING_LEVEL || 'high'
            }
          }
        };

        console.log(`üì§ Chat API Request to ${model}`);

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?alt=sse`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': this.getApiKey()
            },
            body: JSON.stringify(requestBody),
            signal: this.state.abortController.signal
          }
        );

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå Chat API Error (${response.status}):`, errorText);
          throw new Error(`API request failed (${response.status}): ${errorText}`);
        }

        console.log(`‚úÖ Chat API Response: Streaming started`);

        const reader = response.body
          .pipeThrough(new TextDecoderStream())
          .getReader();

        let buffer = '';
        let chunkCount = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += value;
          const events = buffer.split(/\r?\n\r?\n/);
          buffer = events.pop() || '';

          for (const event of events) {
            if (!event.trim()) continue;

            const lines = event.split(/\r?\n/);
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const jsonData = line.slice(6);
                  const chunk = JSON.parse(jsonData);
                  this.handleChatStreamChunk(chunk);
                  chunkCount++;
                } catch (e) {
                  console.error('Parse error:', e, line);
                }
              }
            }
          }
        }

        console.log(`‚úÖ Chat API Response Complete: ${chunkCount} chunks, ${this.state.currentChatResponse.length} chars`);

        return this.state.currentChatResponse;
      },

      handleChatStreamChunk(chunk) {
        const candidate = chunk.candidates?.[0];
        if (!candidate || !candidate.content || !candidate.content.parts) return;

        for (const part of candidate.content.parts) {
          if (part.text) {
            // Handle response text
            this.state.currentChatResponse += part.text;
            this.updateChatStreamingMessage();
          }
        }
      },

      showChatStreamingIndicator() {
        const chatMessages = document.getElementById('chat-messages');
        const streamingDiv = document.createElement('div');
        streamingDiv.id = 'chat-streaming-message';
        streamingDiv.className = 'chat-message assistant';
        streamingDiv.innerHTML = `
          <div class="chat-message-header">Assistant</div>
          <div class="chat-message-content">
            <div id="chat-streaming-response"></div>
            <div class="chat-streaming-indicator">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        `;
        chatMessages.appendChild(streamingDiv);
        this.scrollChatToBottom();
      },

      updateChatStreamingMessage() {
        const responseDiv = document.getElementById('chat-streaming-response');
        if (responseDiv) {
          responseDiv.innerHTML = marked.parse(this.state.currentChatResponse);
          this.scrollChatToBottom();
        }
      },

      renderChatMessages() {
        const chatMessages = document.getElementById('chat-messages');

        // Remove streaming message if exists
        const streamingMsg = document.getElementById('chat-streaming-message');
        if (streamingMsg) {
          streamingMsg.remove();
        }

        // Render all messages
        chatMessages.innerHTML = this.state.chatMessages.map((msg, index) => {
          const roleClass = msg.role === 'user' ? 'user' : 'assistant';
          const header = msg.role === 'user' ? 'You' : 'Assistant';

          return `
            <div class="chat-message ${roleClass}">
              <div class="chat-message-header">${header}</div>
              <div class="chat-message-content">
                ${msg.role === 'assistant' ? marked.parse(msg.content) : this.escapeHtml(msg.content)}
              </div>
            </div>
          `;
        }).join('');

        this.scrollChatToBottom();
      },

      scrollChatToBottom() {
        const container = document.getElementById('chat-messages');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      },

      // ===== End Chat Feature Methods =====

      parseAndRenderOutputs(jsonResponse) {
        try {
          // Clean and extract JSON from response
          let cleanJson = jsonResponse.trim();

          // Remove markdown code fences if present
          if (cleanJson.startsWith('```json')) {
            cleanJson = cleanJson.replace(/^```json\s*/i, '').replace(/\s*```\s*$/, '');
          } else if (cleanJson.startsWith('```')) {
            cleanJson = cleanJson.replace(/^```\s*/, '').replace(/\s*```\s*$/, '');
          }

          // Try to extract JSON object if there's extra text
          const jsonMatch = cleanJson.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            cleanJson = jsonMatch[0];
          }

          console.log('Attempting to parse JSON:', cleanJson.substring(0, 200) + '...');

          // Parse JSON response
          const data = JSON.parse(cleanJson);
          this.state.comparisonData = data;

          // Hide messages container, show output tabs
          document.getElementById('messages').style.display = 'none';
          document.getElementById('output-tabs').classList.add('active');

          // Render each output
          this.renderSummary(data.summary);
          this.renderComparisonSpreadsheet(data.comparison_spreadsheet, data.plan_units);
          this.renderLanguageComparison(data.language_comparison, data.plan_units);

        } catch (error) {
          console.error('Failed to parse JSON response:', error);
          console.error('Raw response:', jsonResponse.substring(0, 500));
          this.handleError(new Error('Failed to parse comparison results. Please try again.'));
        }
      },

      renderSummary(summaryData) {
        const output = document.getElementById('summary-output');

        let markdown = '## Document Inventory\n\n';
        summaryData.document_inventory.forEach(unit => {
          markdown += `### ${unit.plan_unit}\n`;
          unit.documents.forEach(doc => {
            markdown += `- **${doc.type}** (Effective: ${doc.effective_date}) - ${doc.filename}\n`;
          });
          markdown += '\n';
        });

        markdown += '## Key Findings\n\n';
        summaryData.key_findings.forEach(finding => {
          markdown += `- ${finding}\n`;
        });

        markdown += '\n## Completeness Assessment\n\n';
        markdown += summaryData.completeness_assessment + '\n\n';

        markdown += '## Recommendations\n\n';
        summaryData.recommendations.forEach(rec => {
          markdown += `- ${rec}\n`;
        });

        output.innerHTML = marked.parse(markdown);
      },

      renderComparisonSpreadsheet(spreadsheetData, planUnits) {
        const output = document.getElementById('comparison-output');

        let html = '<table class="comparison-table"><thead><tr>';

        // Headers: Procedure Element + all plan units
        html += '<th>Procedure Element</th>';
        planUnits.forEach(planName => {
          html += `<th>${this.escapeHtml(planName)}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Rows: Iterate through procedure elements
        spreadsheetData.rows.forEach(row => {
          html += '<tr>';
          html += `<td>${this.escapeHtml(row.procedure_element)}</td>`;

          // Add value for each plan (should match planUnits array order)
          row.plan_values.forEach(value => {
            html += `<td>${this.escapeHtml(value || 'Not specified')}</td>`;
          });

          html += '</tr>';
        });

        html += '</tbody></table>';
        output.innerHTML = html;
      },

      renderLanguageComparison(languageData, planUnits) {
        const output = document.getElementById('language-output');

        let html = '';
        languageData.rows.forEach(row => {
          html += `<div class="language-row">`;
          html += `<div class="language-row-header">${this.escapeHtml(row.procedure_element)}</div>`;

          // Iterate through plan_details array, using planUnits for names
          row.plan_details.forEach((details, index) => {
            const planName = planUnits[index] || `Plan ${index + 1}`;

            html += `<div class="plan-language">`;
            html += `<div class="plan-name">${this.escapeHtml(planName)}</div>`;
            html += `<div class="plan-summary">${this.escapeHtml(details.summary)}</div>`;
            html += `<div class="plan-full-text">${this.escapeHtml(details.full_text)}</div>`;
            html += `<div class="plan-citation">${this.escapeHtml(details.citation)}</div>`;
            html += `</div>`;
          });

          html += `</div>`;
        });

        output.innerHTML = html;
      },

      // ===== Download Functions =====

      downloadSummary() {
        if (!this.state.summaryResponse) return;

        // Download the summary response as markdown
        const markdown = '# SPD Comparison Summary\n\n' + this.state.summaryResponse;

        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'SPD_Comparison_Summary.md';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      downloadComparisonSpreadsheet() {
        if (!this.state.comparisonResponse) return;

        // Download the comparison table as markdown
        const markdown = '# SPD Comparison Table\n\n' + this.state.comparisonResponse;

        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'SPD_Comparison_Table.md';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      downloadLanguageComparison() {
        if (!this.state.languageResponse) return;

        // Download the language comparison as markdown
        const markdown = '# SPD Language Comparison\n\n' + this.state.languageResponse;

        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'SPD_Language_Comparison.md';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    };

    // Check if config is loaded
    if (typeof CONFIG === 'undefined' || !CONFIG.GEMINI_API_KEY) {
      document.body.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <h2 style="color: var(--error);">Configuration Error</h2>
          <p>Please create a <code>config-gemini.js</code> file with your Gemini API key.</p>
          <p>See <code>config-gemini.example.js</code> for template.</p>
        </div>
      `;
    } else {
      // Initialize app
      ChatApp.init();
    }
  </script>
</body>
</html>
